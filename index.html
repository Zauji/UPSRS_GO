<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>UPSRS GO! - Pro Edition</title>

<!-- Tailwind CSS -->
<script>
  // Disable Tailwind CDN production warning
  window.TAILWIND_DISABLE_TOUCH = true;
  const originalWarn = console.warn;
  console.warn = function(...args) {
    if (typeof args[0] === 'string' && args[0].includes('cdn.tailwindcss.com should not be used in production')) {
      return;
    }
    return originalWarn.apply(console, args);
  };
</script>
<script src="https://cdn.tailwindcss.com"></script>

<!-- DayJS -->
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/locale/id.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/customParseFormat.js"></script>
<script>
dayjs.extend(dayjs_plugin_customParseFormat);
dayjs.locale('id');
</script>

<!-- Alpine.js -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- ExcelJS -->
<script src="https://cdn.jsdelivr.net/npm/exceljs@4.3.0/dist/exceljs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

<script>
  // Simple Supabase client initialization
  const supabaseUrl = "https://zxlegpyzieciwykzjhon.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4bGVncHl6aWVjaXd5a3pqaG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjY4MzAsImV4cCI6MjA4NTI0MjgzMH0.bA_2LtumthKROSnEzIZEbFPYiQ6tT7vqeWOo7IO0haQ";

  try {
    window.supabaseClient = supabase.createClient(
      supabaseUrl,
      supabaseKey
    );
    
    // OPTIMASI: Connection health check
    window.supabaseHealthy = true;
    
    console.log('‚úÖ Supabase client initialized (Simple):', supabaseUrl);
    console.log('üåê Environment:', window.location.hostname.includes('vercel.app') ? 'Vercel Production' : 'Local Development');
    
    // PERBAIKI: Test connection ke Supabase
    testSupabaseConnection();
    
  } catch (error) {
    console.error('‚ùå Failed to initialize Supabase client:', error);
    window.supabaseHealthy = false;
    console.warn('‚ö†Ô∏è Application will run in offline mode');
  }
  
  // PERBAIKI: Fungsi test koneksi
  async function testSupabaseConnection() {
    try {
      console.log('üîç Testing Supabase connection...');
      
      // Test 1: Cek akses ke users table
      console.log('üìä Testing users table access...');
      const { data: usersData, error: usersError } = await window.supabaseClient
        .from('users')
        .select('count')
        .limit(1);
      
      if (usersError) {
        console.error('‚ùå Users table access failed:', usersError);
        console.error('‚ùå Users error details:', {
          message: usersError.message,
          details: usersError.details,
          hint: usersError.hint,
          code: usersError.code
        });
      } else {
        console.log('‚úÖ Users table accessible!');
      }
      
      // Test 2: Cek akses ke tasks table
      console.log('üìä Testing tasks table access...');
      const { data: tasksData, error: tasksError } = await window.supabaseClient
        .from('tasks')
        .select('count')
        .limit(1);
      
      if (tasksError) {
        console.error('‚ùå Tasks table access failed:', tasksError);
        console.error('‚ùå Tasks error details:', {
          message: tasksError.message,
          details: tasksError.details,
          hint: tasksError.hint,
          code: tasksError.code
        });
      } else {
        console.log('‚úÖ Tasks table accessible!');
      }
      
      // Test 3: Cek struktur users table
      console.log('üîç Testing users table structure...');
      const { data: usersStructure, error: structureError } = await window.supabaseClient
        .from('users')
        .select('*')
        .limit(1);
      
      if (structureError) {
        console.error('‚ùå Users table structure test failed:', structureError);
      } else {
        console.log('‚úÖ Users table structure:', usersStructure);
      }
      
      // Test 4: Cek jumlah data
      console.log('üìä Checking existing data...');
      const { data: existingUsers, error: countError } = await window.supabaseClient
        .from('users')
        .select('id, name, username, role')
        .neq('role', 'admin');
      
      if (countError) {
        console.error('‚ùå Count users failed:', countError);
      } else {
        console.log('üìä Existing users:', existingUsers?.length || 0);
        console.log('üë• Sample users:', existingUsers?.slice(0, 3));
      }
      
      if (usersError || tasksError) {
        window.supabaseHealthy = false;
        console.error('‚ùå Supabase connection test failed');
      } else {
        console.log('‚úÖ Supabase connection test successful!');
        window.supabaseHealthy = true;
      }
    } catch (testError) {
      console.error('‚ùå Supabase connection test error:', testError);
      window.supabaseHealthy = false;
    }
  }

  // OPTIMASI: Network status monitoring
  window.addEventListener('online', () => {
    console.log('üåê Network online - enabling sync');
    window.supabaseHealthy = true;
  });
  
  window.addEventListener('offline', () => {
    console.log('üìµ Network offline - disabling sync');
    window.supabaseHealthy = false;
  });
</script>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
[x-cloak]{display:none !important}
body{font-family:'Plus Jakarta Sans',sans-serif;background:#f8fafc}
.input-style{width:100%;padding:1rem;border-radius:1rem;font-weight:600;background:#f1f5f9;border:1px solid transparent;outline:none;transition:all 0.3s}
.input-style:focus{background:white;border-color:#3b82f6;box-shadow:0 0 0 2px rgba(59,130,246,0.1)}
textarea.input-style{min-height:100px;resize:vertical}
select.input-style{cursor:pointer}
</style>

<script>
function appData(){
return{
page:'login',
currentUser:null,
viewingTask:null,
viewingUser:null,
isExporting:false,
editingUser:null,

// Detail statistics modal controls
showDailyDetail:false,
showWeeklyDetail:false,
showMonthlyDetail:false,
showWeeklyByWeekDetail:false,

authName:'',
authUsername:'',
authPassword:'',
authSpecialization:'',
authProfilePhoto:null,
showPass:false,

filterPeriod:'all',

newTask:{
gedung:'',
ruangan:'',
pelapor:'',
masalah:'',
penyelesaian:'',
statusPekerjaan:'Selesai',
alasanPending:'',
foto:null
},

newUserProfile:{
name:'',
username:'',
password:'',
profilePhoto:null
},

dataLokasi:{
'Gedung Klinik':['Administrasi','Apotek','Aula','Depan Klinik','Kamar Dokter Wanita','Kamar Mandi','Parkiran Klinik','Pojok Asi','Poli KIA','Poli Umum','Rekam Medis','Ruang PI','Ruang Tunggu','Ruang UGD'],
'RS Lantai 1':['Administrasi','Anamesa','Farmasi','Kamar Dokter','Laboratorium','Lobby Depan','Nurse Station Lantai 1','Pendaftaran','PIPP','Pojok Asi','Poli Anak','Poli Bedah','Poli Obgyn','Poli Urologi/Penyakit Dalam','Rekam Medis','UGD Maternal','UGD Umum'],
'RS Lantai 2':['Aula','Nurse Station Lantai 2','Ranap Alpukat','Ranap Anggur','Ranap Apel','Ranap Delima','Ranap Dukuh','Ranap Durian','Ranap Isolasi Airbone','Ranap Isolasi Umum','Ranap Jeruk','Ranap Kiwi','Ranap Leci','Ranap Lemon','Ranap Manggis','Ranap Melon','Ranap Nangka','Ranap Semangka','ESWL'],
'OKA':['Kamar Mandi','Oksigen Sentral','Ruang CSSD','Ruang Ganti Dokter','Ruang Ganti Perawat','Ruang HCU','Ruang OKA 1','Ruang OKA 2','Ruang Persiapan Operasi','Ruang PI','Ruang Rehabilitasi Medis','Ruang Tengah'],
'ICU':['Kamar Dokter Atas','Kamar Mandi','Ruang HCU','Ruang ICU','Ruang Perina','Ruang Tengah'],
'Kantin':['Dapur Lantai Atas','Gudang Kantin','Inventory','Kamar Dokter','Ruang Makan','Ruang Masak','Ruang Terbuka Atas'],
'Paviliun':['Gudang Kebersihan','Pantry','Ruang Bagian Umum','Ruang Casemix','Ruang Direktur','Ruang Keuangan','Ruang Marketing','Ruang Server'],
'Lainnya':['Dapur','Genset','Ruang Barang','Ruang Berkas','Linen','Mess Belakang','Mess Depan','Mushola','Parkiran Umum','Parkiran Karyawan','UPSRS']
},

savedTasks:[],
registeredUsers:[],

// Missing properties for Alpine.js
editingTask:null,
editingUserProfile:{
newName:'',
newUsername:'',
newPassword:'',
newSpecialization:'',
profile_photo:null
},

// Cache properties for performance
_cachedAllTasks: null,
_cacheTimestamp: null,
_cacheTimeout: 30000,
_isFetching: false,
_lastFetchTime: null,
_lastDebugLog: 0, // PERBAIKI: Throttle debug logging

// PERBAIKI: Cache untuk statistics untuk menghindari infinite loop
_cachedStats: null,
_cachedStatsTimestamp: null,
_statsCacheTimeout: 5000, // 5 detik cache

// OPTIMASI LANJUTAN: Pagination & Lazy Loading
_currentPage: 1,
_pageSize: 50,
_totalPages: 1,
_hasMoreTasks: true,
_prefetchCache: new Map(), // Prefetch next page
_quickSyncEnabled: true, // Quick sync for recent changes
_lastSyncTime: 0, // Track last sync time

// OPTIMASI: User cache properties
_cachedUsers: null,
_usersCacheTimestamp: null,
_usersCacheTimeout: 60000, // 1 minute cache for users

// Loading states
isLoading: false,
syncStatus: '',

// PERBAIKI: Fungsi cache statistics
getCachedStats(calculateFunction, cacheKey) {
  const now = Date.now();
  
  // Check cache
  if (this._cachedStats && this._cachedStatsTimestamp && 
      (now - this._cachedStatsTimestamp) < this._statsCacheTimeout) {
    return this._cachedStats[cacheKey] || calculateFunction();
  }
  
  // Calculate fresh stats
  if (!this._cachedStats) {
    this._cachedStats = {};
  }
  this._cachedStats[cacheKey] = calculateFunction();
  this._cachedStatsTimestamp = now;
  
  return this._cachedStats[cacheKey];
},

// PERBAIKI: Clear cache stats
clearStatsCache() {
  this._cachedStats = null;
  this._cachedStatsTimestamp = null;
},

// üü¢ LANGKAH 2 ‚Äî Sync dari Supabase (OPTIMIZED)
async syncFromSupabase() {
  if (!this.currentUser) return;

  console.log('üîÑ Syncing tasks from Supabase for user:', this.currentUser.id, this.currentUser.username);
  
  try {
    // OPTIMASI: Quick sync untuk perubahan terakhir
    if (this._quickSyncEnabled && this._lastSyncTime > 0) {
      const timeDiff = Date.now() - this._lastSyncTime;
      if (timeDiff < 60000) { // 1 menit
        console.log('‚ö° Using quick sync - last sync was recent');
        return;
      }
    }
    
    // OPTIMASI: Admin sync semua task, user sync task sendiri
    let query = window.supabaseClient
      .from('tasks')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(this._pageSize); // OPTIMASI: Pagination

    // Jika admin, ambil semua task. Jika user, ambil task user saja
    if (this.currentUser.role !== 'admin') {
      query = query.eq('user_id', this.currentUser.id);
    }
    
    const { data, error } = await query;

    if (!error && data) {
      console.log('üîç DEBUG syncFromSupabase:', {
        currentUserRole: this.currentUser?.role,
        currentUserID: this.currentUser?.id,
        dataLength: data.length,
        isAdmin: this.currentUser?.role === 'admin',
        sampleData: data.slice(0, 2)
      });
      
      const formattedData = data.map(task => {
        const formatted = {
          id: task.id,
          user_id: task.user_id,
          nama: task.nama,
          username: task.username,
          tanggal: task.tanggal,
          waktu: task.waktu,
          gedung: task.gedung,
          ruangan: task.ruangan,
          pelapor: task.pelapor,
          masalah: task.masalah,
          penyelesaian: task.penyelesaian,
          status_pekerjaan: task.status_pekerjaan,
          statusPekerjaan: task.statusPekerjaan
        };
        // Hapus field foto untuk hemat space
        if (task.foto && task.foto.length > 1000) {
          formatted.foto = '[IMAGE_DATA]';
        } else {
          formatted.foto = task.foto;
        }
        return formatted;
      });
      
      // OPTIMASI: Append to existing data untuk pagination
      if (this._currentPage === 1) {
        this.savedTasks = formattedData;
      } else {
        this.savedTasks = [...this.savedTasks, ...formattedData];
      }
      
      console.log('üîç DEBUG after saving to savedTasks:', {
        savedTasksLength: this.savedTasks.length,
        currentPage: this._currentPage,
        isAdmin: this.currentUser?.role === 'admin',
        sampleSavedTasks: this.savedTasks.slice(0, 2)
      });
      
      // OPTIMASI: Check if more data available
      this._hasMoreTasks = data.length === this._pageSize;
      this._totalPages = Math.ceil(this.savedTasks.length / this._pageSize);
      
      // OPTIMASI: Prefetch next page
      if (this._hasMoreTasks) {
        this.prefetchNextPage();
      }
      
      // PERBAIKI: Handle localStorage quota error dengan lebih baik
      try {
        localStorage.setItem('upsrs_tasks_v3', JSON.stringify(this.savedTasks));
        console.log('üíæ Tasks saved to localStorage successfully');
      } catch (quotaError) {
        if (quotaError.name === 'QuotaExceededError') {
          console.warn('‚ö†Ô∏è localStorage quota exceeded, trying optimization...');
          
          // Coba kompres data dengan menghapus field yang tidak perlu
          const compressedData = this.savedTasks.map(task => {
            const compressed = {
              id: task.id,
              user_id: task.user_id,
              nama: task.nama,
              username: task.username,
              tanggal: task.tanggal,
              waktu: task.waktu,
              gedung: task.gedung,
              ruangan: task.ruangan,
              pelapor: task.pelapor,
              masalah: task.masalah,
              penyelesaian: task.penyelesaian,
              status_pekerjaan: task.status_pekerjaan,
              statusPekerjaan: task.statusPekerjaan
            };
            // Hapus field foto untuk hemat space
            if (task.foto && task.foto.length > 1000) {
              compressed.foto = '[IMAGE_DATA]';
            } else {
              compressed.foto = task.foto;
            }
            return compressed;
          });
          
          try {
            localStorage.setItem('upsrs_tasks_v3', JSON.stringify(compressedData));
            console.log('üíæ Tasks saved with compression');
          } catch (retryError) {
            console.warn('‚ö†Ô∏è Still cannot save, clearing old data...');
            localStorage.removeItem('upsrs_tasks_v3');
            try {
              localStorage.setItem('upsrs_tasks_v3', JSON.stringify(compressedData));
              console.log('üíæ Tasks saved after clearing old data');
            } catch (finalError) {
              console.error('‚ùå Cannot save to localStorage, using memory only');
              // Continue tanpa localStorage - data stays in memory
            }
          }
        } else {
          console.error('‚ùå Error saving to localStorage:', quotaError);
        }
      }
      
      // OPTIMASI: Update last sync time
      this._lastSyncTime = Date.now();
      
      console.log('‚úÖ Tasks loaded from Supabase:', data.length);
      
      // DEBUG: Log task samples (reduced frequency)
      if(!this._lastDebugLog || Date.now() - this._lastDebugLog > 5000) {
        console.log('üìù Task samples:', data.slice(0, 3).map(t => ({
          id: t.id,
          user_id: t.user_id,
          masalah: t.masalah,
          status: t.status_pekerjaan
        })));
        this._lastDebugLog = Date.now();
      }
    } else {
      console.warn('‚ö†Ô∏è Supabase sync error:', error);
      console.warn('‚ö†Ô∏è Supabase gagal, pakai localStorage');
    }
  } catch (syncError) {
    console.error('‚ùå Critical sync error:', syncError);
    console.warn('‚ö†Ô∏è Sync failed, using localStorage data');
  }
},

// OPTIMASI: Prefetch next page untuk faster loading
async prefetchNextPage() {
  if (!this._hasMoreTasks || this._prefetchCache.has(this._currentPage + 1)) {
    return;
  }
  
  try {
    const nextPage = this._currentPage + 1;
    let query = window.supabaseClient
      .from('tasks')
      .select('*')
      .order('created_at', { ascending: false })
      .range((nextPage - 1) * this._pageSize, nextPage * this._pageSize - 1);
    
    if (this.currentUser.role !== 'admin') {
      query = query.eq('user_id', this.currentUser.id);
    }
    
    const { data } = await query;
    if (data && data.length > 0) {
      this._prefetchCache.set(nextPage, data);
      console.log(`‚ö° Prefetched page ${nextPage} with ${data.length} tasks`);
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Prefetch failed:', error);
  }
},

// OPTIMASI: Quick sync untuk perubahan terbaru
async quickSync() {
  if (!this.currentUser || !this._quickSyncEnabled) return;
  
  try {
    const lastSyncTime = new Date(this._lastSyncTime).toISOString();
    let query = window.supabaseClient
      .from('tasks')
      .select('*')
      .gte('updated_at', lastSyncTime)
      .order('updated_at', { ascending: false });
    
    if (this.currentUser.role !== 'admin') {
      query = query.eq('user_id', this.currentUser.id);
    }
    
    const { data } = await query;
    if (data && data.length > 0) {
      console.log(`‚ö° Quick sync found ${data.length} updated tasks`);
      
      // Update existing tasks dengan data terbaru
      data.forEach(updatedTask => {
        const index = this.savedTasks.findIndex(t => t.id === updatedTask.id);
        if (index !== -1) {
          this.savedTasks[index] = { ...this.savedTasks[index], ...updatedTask };
        } else {
          this.savedTasks.unshift(updatedTask);
        }
      });
      
      this._lastSyncTime = Date.now();
      this.clearCache();
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Quick sync failed:', error);
  }
},

// üü¢ LANGKAH 5 ‚Äî Setup realtime subscription (OPTIMIZED)
setupRealtimeSubscription() {
  if (!window.supabaseClient || !this.currentUser) return;
  
  console.log('üîÑ Setting up realtime subscription...');
  
  // OPTIMASI: Disconnect existing subscription
  if (this._realtimeChannel) {
    this._realtimeChannel.unsubscribe();
  }
  
  this._realtimeChannel = window.supabaseClient
    .channel('tasks-realtime')
    .on(
      'postgres_changes',
      { event: '*', schema: 'public', table: 'tasks' },
      (payload) => {
        console.log('üì° Realtime update received:', payload.eventType);
        
        // OPTIMASI: Quick update tanpa full sync
        if (payload.eventType === 'UPDATE' || payload.eventType === 'INSERT') {
          const newTask = payload.new;
          const index = this.savedTasks.findIndex(t => t.id === newTask.id);
          
          if (index !== -1) {
            this.savedTasks[index] = { ...this.savedTasks[index], ...newTask };
          } else {
            this.savedTasks.unshift(newTask);
          }
          
          this.clearCache();
          console.log('‚ö° Realtime quick update completed');
        } else if (payload.eventType === 'DELETE') {
          const deletedId = payload.old.id;
          this.savedTasks = this.savedTasks.filter(t => t.id !== deletedId);
          this.clearCache();
          console.log('‚ö° Realtime delete completed');
        }
      }
    )
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        console.log('‚úÖ Realtime subscription active');
      } else if (status === 'CHANNEL_ERROR') {
        console.warn('‚ö†Ô∏è Realtime subscription error, retrying...');
        setTimeout(() => this.setupRealtimeSubscription(), 5000);
      }
    });
},

// OPTIMASI: Background sync dengan debouncing
startBackgroundSync() {
  if (this._syncInterval) {
    clearInterval(this._syncInterval);
  }
  
  // OPTIMASI: Sync lebih sering untuk admin, lebih jarang untuk user
  const syncInterval = this.currentUser?.role === 'admin' ? 30000 : 60000; // 30s vs 60s
  
  this._syncInterval = setInterval(() => {
    if (this._quickSyncEnabled) {
      this.quickSync();
    }
  }, syncInterval);
  
  console.log(`‚ö° Background sync started (${syncInterval/1000}s interval)`);
},

initApp(){
  console.log('üöÄ Initializing UPSRS GO...');
  
  // PERBAIKI: Clean localStorage untuk mengatasi quota issue
  this.cleanLocalStorage();
  
  // OPTIMASI: Load localStorage data immediately
  const savedUsers = localStorage.getItem('upsrs_users_v3');
  const savedTasks = localStorage.getItem('upsrs_tasks_v3');
  const savedCurrentUser = localStorage.getItem('upsrs_current_user');

  if(savedUsers){
    try {
      this.registeredUsers = JSON.parse(savedUsers);
      console.log('üìä Loaded users:', this.registeredUsers.length);
    } catch(e) {
      console.warn('‚ö†Ô∏è Failed to parse saved users:', e);
      this.registeredUsers = [];
    }
  }

  if(savedTasks){
    try {
      this.savedTasks = JSON.parse(savedTasks);
      console.log('üìù Loaded tasks:', this.savedTasks.length);
    } catch(e) {
      console.warn('‚ö†Ô∏è Failed to parse saved tasks:', e);
      this.savedTasks = [];
    }
  }

  if(savedCurrentUser){
    try {
      this.currentUser = JSON.parse(savedCurrentUser);
      console.log('üë§ Current user found:', this.currentUser?.username, 'Role:', this.currentUser?.role);
      // Check if current user is Super Admin and redirect to admin dashboard
      if(this.currentUser?.username==='Admin' && this.currentUser?.role==='admin'){
        this.page='adminDashboard';
        console.log('üëë Redirecting to admin dashboard');
      }else{
        this.page='dashboard';
        console.log('üë§ Redirecting to user dashboard');
      }
    } catch(e) {
      console.warn('‚ö†Ô∏è Failed to parse saved current user:', e);
      this.currentUser = null;
    }
  }else{
    console.log('üîì No current user found');
    this.page='login';
  }

  // Ensure Super Admin account always exists
  const adminUser=this.registeredUsers.find(x=>x.username==='Admin');

  if(!adminUser){
    this.registeredUsers.push({id:'admin',name:'Super Admin',username:'Admin',password:'admin123',role:'admin',profilePhoto:null});
    localStorage.setItem('upsrs_users_v3',JSON.stringify(this.registeredUsers));
    console.log('üëë Created default Admin user');
  }else{
    console.log('üëë Admin user already exists');
  }

  console.log('‚úÖ UPSRS GO initialized successfully');

  // üü¢ LANGKAH 5 ‚Äî Realtime subscription (opsional)
  if(window.supabaseClient && this.currentUser){
    this.setupRealtimeSubscription();
    
    // OPTIMASI: Start background sync
    this.startBackgroundSync();
  }

  // OPTIMASI: Background sync dengan delay untuk UI responsiveness
  if(window.supabaseClient && this.currentUser){
    console.log('üîÑ Starting background sync...');
    console.log('üîç DEBUG initApp:', {
      currentUser: this.currentUser?.username,
      userRole: this.currentUser?.role,
      isAdmin: this.currentUser?.role === 'admin',
      savedTasksLength: this.savedTasks.length
    });
    
    // Load users first, then tasks
    setTimeout(async () => {
      console.log('‚è∞ Starting delayed sync...');
      await this.fetchUsers();
      await this.fetchTasks();
      
      console.log('üîç DEBUG after fetchTasks:', {
        savedTasksLength: this.savedTasks.length,
        isAdmin: this.currentUser?.role === 'admin'
      });
      
      // OPTIMASI: Prefetch data untuk faster navigation
      if (this.currentUser?.role === 'admin') {
        this.prefetchNextPage();
      }
    }, 500);
  }
},

// Delete all registered accounts
deleteAllAccounts(){
if(!confirm('Apakah Anda yakin ingin menghapus SEMUA akun yang terdaftar? Tindakan ini tidak dapat dibatalkan!'))return;
this.registeredUsers=[];
localStorage.setItem('upsrs_users_v3',JSON.stringify(this.registeredUsers));
localStorage.removeItem('upsrs_current_user');
this.currentUser=null;
this.page='login';
alert('Semua akun telah dihapus!');
},

get filteredTasks(){
try{
// PERBAIKI: Kurangi debug logging frequency
if(!this._lastDebugLog || Date.now() - this._lastDebugLog > 5000) {
  console.log('üîç DEBUG: Filtering tasks for user:', {
    currentUser: this.currentUser?.username,
    userId: this.currentUser?.id,
    role: this.currentUser?.role,
    totalSavedTasks: this.savedTasks.length
  });
  this._lastDebugLog = Date.now();
}

// Return empty array if no current user
if(!this.currentUser){
return [];
}

// PERBAIKI: Admin melihat semua task tanpa filter
if(this.currentUser?.role === 'admin'){
return this.savedTasks; // Admin lihat semua task
}

// PERBAIKI: Regular users hanya lihat task sendiri
const currentUserId = this.currentUser.id || this.currentUser.username;
const userTasks = this.savedTasks.filter(task => task.user_id === currentUserId);

if(this.filterPeriod==='all')return userTasks;

const now=dayjs();
const filteredByPeriod = userTasks.filter(t=>{
  const d=dayjs(t.tanggal,'DD/MM/YYYY');
  if(!d.isValid())return false;
  if(this.filterPeriod==='today')return d.isSame(now,'day');
  if(this.filterPeriod==='week')return d.isAfter(now.subtract(7,'day'));
  if(this.filterPeriod==='month')return d.isSame(now,'month');
  return false;
});

return filteredByPeriod;

}catch(error){
console.error('‚ùå Error in filteredTasks:', error);
return [];
}
},

get stats(){
try{
  // PERBAIKI: Admin lihat statistik semua task, user lihat statistik task sendiri
  let tasksForStats;
  
  if(this.currentUser?.role === 'admin'){
    // Admin: Gunakan semua task yang tersimpan
    tasksForStats = this.savedTasks;
    console.log('üìä Admin stats - using all savedTasks:', tasksForStats.length);
  } else {
    // User: Gunakan filtered tasks (task sendiri)
    tasksForStats = this.filteredTasks;
    console.log('üìä User stats - using filteredTasks:', tasksForStats.length);
  }
  
  const stats = {
    total: tasksForStats.length,
    selesai: tasksForStats.filter(t=>t.status_pekerjaan==='Selesai').length,
    pending: tasksForStats.filter(t=>t.status_pekerjaan!=='Selesai').length
  };
  
  // DEBUG: Log statistik untuk admin
  if(this.currentUser?.role === 'admin'){
    console.log('üìä Admin statistics:', {
      totalTasks: this.savedTasks.length,
      statsCalculated: stats,
      sampleTasks: this.savedTasks.slice(0, 3).map(t => ({
        id: t.id,
        user_id: t.user_id,
        masalah: t.masalah,
        status: t.status_pekerjaan
      }))
    });
    
    // PERBAIKI: Log detail statistik
    console.log('üìà Admin stats detail:', {
      todayTasks: stats.todayTasks,
      weeklyTasks: stats.weeklyTasks,
      thisWeekCompleted: stats.thisWeekCompleted,
      monthlyTasks: stats.monthlyTasks,
      thisMonthCompleted: stats.thisMonthCompleted
    });
  }
  
  return stats;
} catch(error){
  console.error('‚ùå Error in stats calculation:', error);
  return {total: 0, selesai: 0, pending: 0};
}
},

async handleLogin(){
  if(!this.authUsername || !this.authPassword)
    return alert('Isi username dan password!');

  // Try Supabase first if available
  if (window.supabaseClient) {
    try {
      const { data, error } = await supabaseClient
        .from('users')
        .select('*')
        .eq('username', this.authUsername)
        .eq('password', this.authPassword)
        .single();

      if (!error && data) {
        console.log('‚úÖ User found in Supabase:', data);
        this.currentUser = data;
        localStorage.setItem('upsrs_current_user', JSON.stringify(data));
        console.log('üë§ Current user set to:', this.currentUser);
        
        // üü¢ LANGKAH 2 ‚Äî Panggil sync setelah login sukses
        this.syncFromSupabase();
        
        // üü¢ LANGKAH 5 ‚Äî Setup realtime setelah login
        this.setupRealtimeSubscription();
        
        this.page = data.role === 'admin' ? 'adminDashboard' : 'dashboard';
        this.authUsername = '';
        this.authPassword = '';
        return;
      }
    } catch (supabaseError) {
      console.warn('Supabase login failed, trying fallback:', supabaseError);
    }
  }

  // Fallback to localStorage
  const u = this.registeredUsers.find(x => x.username === this.authUsername && x.password === this.authPassword);
  if (!u) {
    return alert('Login gagal! Periksa username dan password.');
  }

  this.currentUser = u;
  localStorage.setItem('upsrs_current_user', JSON.stringify(u));
  
  // üü¢ LANGKAH 2 ‚Äî Panggil sync setelah login sukses (fallback)
  this.syncFromSupabase();
  
  // üü¢ LANGKAH 5 ‚Äî Setup realtime setelah login
  this.setupRealtimeSubscription();
  
  this.page = u.role === 'admin' ? 'adminDashboard' : 'dashboard';
  this.authUsername = '';
  this.authPassword = '';
},

async handleRegister(){
  if(!this.authName || !this.authUsername || !this.authPassword)
    return alert('Lengkapi data!');

  console.log('üîç DEBUG handleRegister:', {
    name: this.authName,
    username: this.authUsername,
    specialization: this.authSpecialization,
    hasProfilePhoto: !!this.authProfilePhoto
  });

  // PERBAIKI: Test koneksi Supabase sebelum registrasi
  if (window.supabaseClient && window.supabaseHealthy) {
    try {
      console.log('üì§ Attempting to register user to Supabase...');
      
      // Test 1: Cek koneksi dasar
      console.log('üîç Testing basic connection...');
      const { data: testData, error: testError } = await window.supabaseClient
        .from('users')
        .select('count')
        .limit(1);
      
      if (testError) {
        console.error('‚ùå Connection test failed:', testError);
        throw new Error('Supabase connection failed: ' + testError.message);
      }
      
      console.log('‚úÖ Connection test passed');
      
      // Test 2: Cek apakah username sudah ada
      console.log('üîç Checking if username exists...');
      const { data: existingUser, error: checkError } = await window.supabaseClient
        .from('users')
        .select('username')
        .eq('username', this.authUsername)
        .single();
      
      if (checkError && checkError.code !== 'PGRST116') {
        console.error('‚ùå Username check failed:', checkError);
      } else if (existingUser) {
        console.warn('‚ö†Ô∏è Username already exists:', existingUser);
        alert('Username sudah digunakan! Silakan pilih username lain.');
        return;
      }
      
      // Test 3: Registrasi user baru
      console.log('üì§ Inserting new user...');
      const userData = {
        name: this.authName,
        username: this.authUsername,
        password: this.authPassword,
        role: 'user',
        specialization: this.authSpecialization || ''
        // PERBAIKI: Hapus profile_photo untuk menghindari HTTP 400
      };
      
      console.log('üìä User data to insert:', userData);
      
      const { data, error } = await window.supabaseClient
        .from('users')
        .insert([userData])
        .select();

      console.log('üîç DEBUG Supabase registration result:', {
        data: data,
        error: error?.message,
        success: !error,
        errorCode: error?.code,
        errorDetails: error?.details
      });

      if(error){
        console.error('‚ùå Registration error details:', {
          message: error.message,
          details: error.details,
          hint: error.hint,
          code: error.code
        });
        
        // Coba fallback ke localStorage jika error spesifik
        if (error.code === '42501' || error.message.includes('permission')) {
          console.warn('‚ö†Ô∏è Permission denied, falling back to localStorage');
        } else {
          throw error;
        }
      } else {
        console.log('‚úÖ User registered successfully:', data);
        alert('Daftar berhasil! Silakan login');
        this.page='login';
        this.authName='';
        this.authUsername='';
        this.authPassword='';
        
        // PERBAIKI: Refresh users list jika admin sedang login
        if (this.currentUser?.role === 'admin') {
          console.log('üîÑ Refreshing users list after new registration...');
          await this.fetchUsers();
        }
        
        return;
      }
    } catch (supabaseError) {
      console.warn('‚ùå Supabase registration failed, using fallback:', supabaseError);
      console.error('‚ùå Supabase error details:', {
        message: supabaseError.message,
        details: supabaseError.details,
        hint: supabaseError.hint,
        code: supabaseError.code,
        stack: supabaseError.stack
      });
    }
  } else {
    console.warn('‚ö†Ô∏è Supabase not available or unhealthy, using localStorage fallback');
  }

  // Fallback to localStorage
  console.log('üíæ Using localStorage fallback...');
  const newUser = {
    id: Date.now(),
    name: this.authName,
    username: this.authUsername,
    password: this.authPassword,
    role: 'user',
    specialization: this.authSpecialization || '',
    profile_photo: this.authProfilePhoto
  };

  console.log('üìä LocalStorage user data:', newUser);

  this.registeredUsers.push(newUser);
  localStorage.setItem('upsrs_users_v3', JSON.stringify(this.registeredUsers));

  console.log('‚úÖ User saved to localStorage:', this.registeredUsers.length);

  alert('Daftar berhasil! (Mode Offline) Silakan login');
  this.page='login';
  this.authName='';
  this.authUsername='';
  this.authPassword='';
},

// PERBAIKI: Fungsi test debug registration
async testSupabaseRegistration() {
  console.log('üîç ===== DEBUG REGISTRATION TEST START =====');
  
  // Test 1: Cek Supabase connection
  console.log('üìä Test 1: Checking Supabase connection...');
  if (!window.supabaseClient) {
    console.error('‚ùå Supabase client not initialized');
    alert('‚ùå Supabase client not initialized');
    return;
  }
  
  if (!window.supabaseHealthy) {
    console.error('‚ùå Supabase connection unhealthy');
    alert('‚ùå Supabase connection unhealthy');
    return;
  }
  
  console.log('‚úÖ Supabase client and connection healthy');
  
  // Test 2: Cek akses tabel users
  console.log('üìä Test 2: Testing users table access...');
  try {
    const { data: testData, error: testError } = await window.supabaseClient
      .from('users')
      .select('count')
      .limit(1);
    
    if (testError) {
      console.error('‚ùå Users table access failed:', testError);
      alert('‚ùå Users table access failed: ' + testError.message);
      return;
    }
    
    console.log('‚úÖ Users table accessible');
  } catch (error) {
    console.error('‚ùå Users table test error:', error);
    alert('‚ùå Users table test error: ' + error.message);
    return;
  }
  
  // Test 3: Cek data yang akan diinsert
  console.log('üìä Test 3: Preparing test data...');
  const testUser = {
    name: 'Debug Test User',
    username: 'debuguser' + Date.now(),
    password: 'debug123',
    role: 'user',
    specialization: 'Debug Test',
    profile_photo: null
  };
  
  console.log('üìä Test user data:', testUser);
  
  // Test 4: Insert test user
  console.log('üìä Test 4: Inserting test user...');
  try {
    const { data, error } = await window.supabaseClient
      .from('users')
      .insert([testUser])
      .select();
    
    console.log('üîç DEBUG Insert Result:', {
      data: data,
      error: error?.message,
      success: !error,
      errorCode: error?.code,
      errorDetails: error?.details
    });
    
    if (error) {
      console.error('‚ùå Insert failed:', error);
      console.error('‚ùå Full error details:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      
      // Cek jenis error
      if (error.code === '42501') {
        alert('‚ùå Permission denied! RLS policy mungkin memblokir insert. Check Supabase RLS policies.');
      } else if (error.code === '23505') {
        alert('‚ùå Duplicate entry! Username sudah ada.');
      } else if (error.code === 'PGRST116') {
        alert('‚ùå Table tidak ditemukan! Pastikan tabel users ada di Supabase.');
      } else {
        alert('‚ùå Insert failed: ' + error.message + ' (Code: ' + error.code + ')');
      }
      return;
    }
    
    console.log('‚úÖ Test user inserted successfully:', data);
    alert('‚úÖ Test registration successful! User: ' + testUser.username);
    
    // Test 5: Verify insert
    console.log('üìä Test 5: Verifying insert...');
    const { data: verifyData, error: verifyError } = await window.supabaseClient
      .from('users')
      .select('*')
      .eq('username', testUser.username)
      .single();
    
    if (verifyError) {
      console.error('‚ùå Verification failed:', verifyError);
    } else {
      console.log('‚úÖ Verification successful:', verifyData);
    }
    
  } catch (insertError) {
    console.error('‚ùå Insert test error:', insertError);
    alert('‚ùå Insert test error: ' + insertError.message);
    return;
  }
  
  console.log('üîç ===== DEBUG REGISTRATION TEST END =====');
},

// PERBAIKI: Fungsi force reconnect Supabase
async forceReconnectSupabase() {
  console.log('üîÑ ===== FORCE RECONNECT SUPABASE START =====');
  
  try {
    // Step 1: Reset connection status
    console.log('üîÑ Step 1: Resetting connection status...');
    window.supabaseHealthy = false;
    
    // Step 2: Reinitialize Supabase client
    console.log('üîÑ Step 2: Reinitializing Supabase client...');
    const supabaseUrl = "https://zxlegpyzieciwykzjhon.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp4bGVncHl6aWVjaXd5a3pqaG9uIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2NjY4MzAsImV4cCI6MjA4NTI0MjgzMH0.bA_2LtumthKROSnEzIZEbFPYiQ6tT7vqeWOo7IO0haQ";
    
    window.supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    console.log('‚úÖ Supabase client reinitialized');
    
    // Step 3: Test basic connection
    console.log('üîÑ Step 3: Testing basic connection...');
    const { data: testData, error: testError } = await window.supabaseClient
      .from('users')
      .select('count')
      .limit(1);
    
    if (testError) {
      console.error('‚ùå Connection test failed:', testError);
      console.error('‚ùå Full error details:', {
        message: testError.message,
        details: testError.details,
        hint: testError.hint,
        code: testError.code
      });
      
      window.supabaseHealthy = false;
      alert('‚ùå Reconnect failed: ' + testError.message + '\n\nPossible causes:\n‚Ä¢ Supabase URL incorrect\n‚Ä¢ API Key expired\n‚Ä¢ Network issues\n‚Ä¢ Supabase service down');
      return;
    }
    
    // Step 4: Test table access
    console.log('üîÑ Step 4: Testing table access...');
    const { data: tableData, error: tableError } = await window.supabaseClient
      .from('users')
      .select('*')
      .limit(1);
    
    if (tableError) {
      console.error('‚ùå Table access failed:', tableError);
      window.supabaseHealthy = false;
      alert('‚ùå Table access failed: ' + tableError.message + '\n\nPossible causes:\n‚Ä¢ Table "users" not found\n‚Ä¢ RLS policies blocking access\n‚Ä¢ Insufficient permissions');
      return;
    }
    
    // Step 5: Success
    console.log('‚úÖ Connection successful!');
    window.supabaseHealthy = true;
    
    // Step 6: Test insert permission
    console.log('üîÑ Step 6: Testing insert permission...');
    const testUser = {
      name: 'Connection Test User',
      username: 'testuser' + Date.now(),
      password: 'test123',
      role: 'user',
      specialization: 'Connection Test',
      profile_photo: null
    };
    
    const { data: insertData, error: insertError } = await window.supabaseClient
      .from('users')
      .insert([testUser])
      .select();
    
    if (insertError) {
      console.error('‚ùå Insert permission failed:', insertError);
      console.warn('‚ö†Ô∏è Connection successful but insert permission denied');
      alert('‚ö†Ô∏è Connected but INSERT permission denied!\n\nError: ' + insertError.message + '\n\nCheck RLS policies in Supabase dashboard');
    } else {
      console.log('‚úÖ Insert permission confirmed!');
      console.log('üóëÔ∏è Cleaning up test user...');
      
      // Clean up test user
      await window.supabaseClient
        .from('users')
        .delete()
        .eq('username', testUser.username);
      
      alert('‚úÖ Supabase reconnection successful!\n\nüü¢ Status: Online\nüìä Tables: Accessible\n‚úÖ Permissions: Full access\n\nRegistration should work now!');
    }
    
  } catch (reconnectError) {
    console.error('‚ùå Reconnect error:', reconnectError);
    window.supabaseHealthy = false;
    alert('‚ùå Critical reconnect error: ' + reconnectError.message + '\n\nCheck:\n‚Ä¢ Internet connection\n‚Ä¢ Supabase credentials\n‚Ä¢ Browser console for details');
  }
  
  console.log('üîÑ ===== FORCE RECONNECT SUPABASE END =====');
},

async handleAdminLogin(){
  if(!this.authUsername||!this.authPassword)return alert('Isi username dan password admin!');

  // Try Supabase first if available
  if (window.supabaseClient) {
    try {
      const { data, error } = await window.supabaseClient
        .from('users')
        .select('*')
        .eq('username', this.authUsername)
        .eq('password', this.authPassword)
        .eq('role', 'admin')
        .single();

      if(!error && data) {
        this.currentUser = data;
        localStorage.setItem('upsrs_current_user', JSON.stringify(data));
        this.page='adminDashboard';
        this.authUsername='';
        this.authPassword='';
        
        // üü¢ LANGKAH 2 ‚Äî Panggil sync setelah admin login sukses
        await this.syncFromSupabase();
        
        // üü¢ LANGKAH 5 ‚Äî Setup realtime setelah admin login
        this.setupRealtimeSubscription();
        
        // Fetch latest data from Supabase
        await this.fetchUsers();
        await this.fetchTasks();
        
        // PERBAIKI: Force refresh stats setelah admin login
        console.log('üîÑ Forcing stats refresh for admin...');
        this.$nextTick(() => {
          console.log('üìä Admin stats after refresh:', this.stats);
        });
        
        return;
      }
    } catch (supabaseError) {
      console.warn('Supabase admin login failed, trying fallback:', supabaseError);
    }
  }

  // Fallback to localStorage
  const u = this.registeredUsers.find(x => x.username === this.authUsername && x.password === this.authPassword && x.role === 'admin');
  if (!u) {
    return alert('Login admin gagal! Periksa kredensial Anda.');
  }

  this.currentUser = u;
  localStorage.setItem('upsrs_current_user', JSON.stringify(u));
  this.page='adminDashboard';
  this.authUsername='';
  this.authPassword='';
  
  // üü¢ LANGKAH 2 ‚Äî Panggil sync setelah admin login sukses (fallback)
  await this.syncFromSupabase();
  
  // üü¢ LANGKAH 5 ‚Äî Setup realtime setelah admin login
  this.setupRealtimeSubscription();
  
  // Try to sync data even in localStorage mode
  this.fetchUsers();
  this.fetchTasks();
  
  // PERBAIKI: Force refresh stats setelah admin login
  console.log('üîÑ Forcing stats refresh for admin (fallback)...');
  this.$nextTick(() => {
    console.log('üìä Admin stats after refresh (fallback):', this.stats);
  });
},

handleFileUpload(e){
const f=e.target.files[0];
if(!f)return;
const r=new FileReader();
r.onload=ev=>{
const img=new Image();
img.onload=()=>{
const canvas=document.createElement('canvas');
const ctx=canvas.getContext('2d');
canvas.width=img.width;
canvas.height=img.height;
ctx.drawImage(img,0,0,img.width,img.height);
this.newTask.foto=canvas.toDataURL('image/jpeg',0.9);
};
img.src=ev.target.result;
};
r.readAsDataURL(f);
},

handleProfilePhotoUpload(e){
const f=e.target.files[0];
if(!f)return;
const r=new FileReader();
r.onload=ev=>{
const img=new Image();
img.onload=()=>{
const canvas=document.createElement('canvas');
const ctx=canvas.getContext('2d');

// Set fixed size for profile photo (400x400)
const targetSize=400;
canvas.width=targetSize;
canvas.height=targetSize;

// Calculate aspect ratios
const imgRatio=img.width/img.height;
const targetRatio=1; // Square

let drawWidth, drawHeight, offsetX, offsetY;

if(imgRatio>targetRatio){
// Image is wider than tall - fit to height
  drawHeight=img.height;
  drawWidth=drawHeight*targetRatio;
  offsetX=(img.width-drawWidth)/2;
  offsetY=0;
}else{
// Image is taller than wide - fit to width
  drawWidth=img.width;
  drawHeight=drawWidth/targetRatio;
  offsetX=0;
  offsetY=(img.height-drawHeight)/2;
}

// Clear canvas and draw centered image
ctx.fillStyle='#f1f5f9';
ctx.fillRect(0,0,targetSize,targetSize);
ctx.drawImage(img,offsetX,offsetY,drawWidth,drawHeight,0,0,targetSize,targetSize);

// Apply subtle sharpening filter for better quality
ctx.filter='contrast(1.1) brightness(1.05)';
ctx.drawImage(canvas,0,0);

const finalPhoto=canvas.toDataURL('image/jpeg',0.95);
this.authProfilePhoto=finalPhoto;
this.newUserProfile.profilePhoto=finalPhoto;
};
img.src=ev.target.result;
};
r.readAsDataURL(f);
},

async simpanTugas() {
  if (!this.newTask.masalah?.trim()) return alert('Isi Permasalahan Utama!');
  if (!this.newTask.gedung) return alert('Pilih Gedung!');
  if (!this.newTask.ruangan) return alert('Pilih Ruangan!');

  const tindakan = this.newTask.statusPekerjaan === 'Selesai'
    ? this.newTask.penyelesaian
    : this.newTask.alasanPending;

  if (!tindakan?.trim()) return alert('Isi Penyelesaian / Alasan Pending!');

  try {
    const entry = {
      id: Date.now(),
      user_id: this.currentUser.id, // KUNCI UTAMA - WAJIB
      nama: this.currentUser.name, // TAMBAHAN: Nama user
      tanggal: dayjs().format('DD/MM/YYYY'),
      waktu: dayjs().format('HH:mm'),
      gedung: this.newTask.gedung,
      ruangan: this.newTask.ruangan,
      pelapor: this.newTask.pelapor || '',
      masalah: this.newTask.masalah,
      penyelesaian: tindakan,
      status_pekerjaan: this.newTask.statusPekerjaan, // Perbaiki naming
      foto: this.newTask.foto,
      created_at: new Date().toISOString()
    };

    // Try to save to Supabase first (WAJIB untuk user)
    if (window.supabaseClient) {
      try {
        console.log('üîÑ Attempting to save to Supabase...');
        console.log('üìù Entry data:', entry);
        
        const { data, error } = await window.supabaseClient
          .from('tasks')
          .insert([entry]);

        console.log('üìä Supabase response:', { data, error });

        if (error) {
          console.error('‚ùå Supabase error details:', error);
          throw error;
        }

        console.log('‚úÖ Task saved to Supabase:', entry);
        alert('‚úÖ Laporan berhasil disimpan (Online)');
        
        // OPTIMASI: Add task to local cache immediately instead of re-fetching
        this.savedTasks.unshift(entry);
        this.clearCache();
        
        // Optional: Background refresh untuk data terbaru
        setTimeout(() => this.fetchTasks(), 2000);
      } catch (supabaseError) {
        console.error('‚ùå Supabase save failed:', supabaseError);
        console.log('üîç Error details:', {
          message: supabaseError.message,
          details: supabaseError.details,
          hint: supabaseError.hint,
          code: supabaseError.code
        });
        
        // Tambah opsi fallback ke localStorage
        const useOffline = confirm('‚ùå Gagal menyimpan ke server.\n\n' +
          'Error: ' + supabaseError.message + '\n\n' +
          'Apakah ingin menyimpan secara offline (hanya di HP ini)?\n\n' +
          '‚úÖ Ya = Simpan di HP saja\n' +
          '‚ùå Tidak = Coba lagi nanti');
          
        if(useOffline) {
          // Fallback ke localStorage dengan field lama
          const offlineEntry = {
            ...entry,
            teknisi: this.currentUser.name, // Tambah teknisi untuk compatibility
            statusPekerjaan: this.newTask.statusPekerjaan // Gunakan field lama
          };
          
          this.savedTasks.push(offlineEntry);
          localStorage.setItem('upsrs_tasks_v3', JSON.stringify(this.savedTasks));
          console.log('‚úÖ Task saved to localStorage:', offlineEntry);
          alert('‚úÖ Laporan berhasil disimpan (Mode Offline - Hanya di HP ini)');
        } else {
          alert('‚ùå Laporan tidak disimpan. Silakan coba lagi saat koneksi stabil.');
          return;
        }
      }
    } else {
      const useOffline = confirm('‚ùå Tidak ada koneksi ke server.\n\n' +
        'Apakah ingin menyimpan secara offline (hanya di HP ini)?\n\n' +
        '‚úÖ Ya = Simpan di HP saja\n' +
        '‚ùå Tidak = Batalkan');
        
      if(useOffline) {
        const offlineEntry = {
          ...entry,
          teknisi: this.currentUser.name,
          statusPekerjaan: this.newTask.statusPekerjaan
        };
        
        this.savedTasks.push(offlineEntry);
        localStorage.setItem('upsrs_tasks_v3', JSON.stringify(this.savedTasks));
        console.log('‚úÖ Task saved to localStorage:', offlineEntry);
        alert('‚úÖ Laporan berhasil disimpan (Mode Offline - Hanya di HP ini)');
      } else {
        alert('‚ùå Laporan dibatalkan.');
        return;
      }
    }

    /* ================= RESET FORM ================= */
    this.newTask = {
      gedung: '',
      ruangan: '',
      pelapor: '',
      masalah: '',
      penyelesaian: '',
      statusPekerjaan: 'Selesai',
      alasanPending: '',
      foto: null
    };

  } catch (err) {
    console.error('‚ùå Error saving task:', err);
    alert('‚ùå Gagal menyimpan laporan: ' + err.message);
  }
},

async exportToExcel(){
// PERBAIKI: Gunakan data yang tepat untuk user vs admin
let tasksToExport;
let fileName;

if(this.currentUser?.role === 'admin'){
  // Admin: Export semua task
  tasksToExport = this.savedTasks;
  fileName = `Laporan_Admin_UPSRS_${dayjs().format('YYYYMMDD')}.xlsx`;
  console.log('üìä Admin exporting all tasks:', tasksToExport.length);
} else {
  // User: Export task sendiri
  tasksToExport = this.filteredTasks;
  fileName = `Laporan_${this.currentUser?.username}_${dayjs().format('YYYYMMDD')}.xlsx`;
  console.log('üìä User exporting own tasks:', tasksToExport.length);
}

if(tasksToExport.length===0){
  return alert('Tidak ada data untuk diexport');
}

this.isExporting=true;
try{
const wb=new ExcelJS.Workbook();
const ws=wb.addWorksheet('Laporan');
ws.columns=[
{header:'Tanggal',key:'tanggal',width:15},
{header:'Waktu',key:'waktu',width:12},
{header:'Nama',key:'nama',width:20},
{header:'Teknisi',key:'teknisi',width:20},
{header:'Gedung',key:'gedung',width:20},
{header:'Ruangan',key:'ruangan',width:25},
{header:'Pelapor',key:'pelapor',width:20},
{header:'Permasalahan',key:'masalah',width:40},
{header:'Penyelesaian',key:'penyelesaian',width:40},
{header:'Status',key:'statusPekerjaan',width:15},
{header:'Foto',key:'foto',width:20}
];

ws.getRow(1).font={bold:true};
ws.getRow(1).height=20;

for(let i=0;i<tasksToExport.length;i++){
const task=tasksToExport[i];
const row=ws.addRow({
tanggal:task.tanggal,
waktu:task.waktu,
nama:task.nama || 'Unknown',
teknisi:task.teknisi || task.nama || 'Unknown',
gedung:task.gedung,
ruangan:task.ruangan,
pelapor:task.pelapor||'-',
masalah:task.masalah||'-',
penyelesaian:task.penyelesaian||'-',
// PERBAIKI: Gunakan field yang compatible
statusPekerjaan:task.statusPekerjaan || task.status_pekerjaan || 'Unknown',
foto:task.foto?'Ada':'Tidak Ada'
});

row.height=task.foto?80:20;

if(task.foto){
try{
let base64Data=task.foto;
if(base64Data.includes(','))base64Data=base64Data.split(',')[1];
const binaryString=atob(base64Data);
const bytes=new Uint8Array(binaryString.length);
for(let j=0;j<binaryString.length;j++)bytes[j]=binaryString.charCodeAt(j);
const imageId=wb.addImage({buffer:bytes,extension:'jpeg'});
ws.addImage(imageId,{tl:{col:10,row:i+2},ext:{width:120,height:90}});
const fotoCell=row.getCell(11);
fotoCell.alignment={vertical:'middle',horizontal:'center'};
}catch(e){console.error('Error adding image:',e);}
}
}

const buffer=await wb.xlsx.writeBuffer();
const blob=new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
saveAs(blob, fileName);
console.log('‚úÖ Excel exported successfully:', fileName);
}catch(e){
console.error('‚ùå Export error:', e);
alert('Gagal export: '+e.message);
}finally{
this.isExporting=false;
}
},

logout(){
localStorage.removeItem('upsrs_current_user');
this.currentUser=null;
this.page='login';
},

// Admin and User Management Functions
get isAdmin(){
return this.currentUser?.role==='admin';
},

async fetchUsers(){
  // Skip if Supabase is not available (offline mode)
  if (!window.supabaseClient) {
    console.log('üìä Using localStorage for users (offline mode)');
    return;
  }

  console.log('üîç DEBUG fetchUsers:', {
    currentUser: this.currentUser?.username,
    userRole: this.currentUser?.role,
    isAdmin: this.currentUser?.role === 'admin'
  });

  try {
    console.log('üì§ Fetching users from Supabase...');
    
    const { data, error } = await window.supabaseClient
      .from('users')
      .select('*')
      .neq('role','admin');

    console.log('üîç DEBUG fetchUsers result:', {
      dataLength: data?.length || 0,
      error: error?.message,
      success: !error,
      sampleData: data?.slice(0, 3)
    });

    if(!error && data){
      this.registeredUsers = data;
      localStorage.setItem('upsrs_users_v3', JSON.stringify(this.registeredUsers));
      console.log('‚úÖ Users fetched from Supabase:', data.length);
      console.log('üìä Updated registeredUsers:', this.registeredUsers.map(u => ({
        id: u.id,
        name: u.name,
        username: u.username,
        role: u.role
      })));
    } else {
      console.error('‚ùå Error fetching users:', error);
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è Failed to fetch users from Supabase, using localStorage:', error);
    console.error('‚ùå Fetch users error details:', {
      message: error.message,
      stack: error.stack
    });
  }
},

async fetchTasks(){
  // OPTIMASI: Network health check
  if (!window.supabaseClient || !window.supabaseHealthy) {
    console.log('üìä Using localStorage for tasks (offline/unhealthy mode)');
    return;
  }

  // OPTIMASI: Check cache first - tapi force fetch untuk admin
  const now = Date.now();
  const isAdmin = this.currentUser?.role === 'admin';
  
  if(!isAdmin && this._cachedAllTasks && this._cacheTimestamp && (now - this._cacheTimestamp) < this._cacheTimeout){
    console.log('‚ö° Using cached tasks, skipping fetch (user mode)');
    this.savedTasks = this._cachedAllTasks;
    return;
  }

  // Admin selalu fetch fresh data
  if(isAdmin){
    console.log('üëë Admin user - force fetching fresh tasks from Supabase');
    this.clearCache(); // Clear cache untuk admin
  }

  try {
    console.log('üöÄ Fast fetching tasks from Supabase...');
    const startTime = performance.now();
    
    // PERBAIKI: Admin ambil semua task, user ambil task sendiri
    let query = window.supabaseClient
      .from('tasks')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(500);
    
    // Jika bukan admin, filter by user_id
    if(!isAdmin) {
      query = query.eq('user_id', this.currentUser.id);
    }
    
    const { data: tasks, error: tasksError } = await query;

    console.log('üîç DEBUG fetchTasks:', {
      isAdmin: isAdmin,
      currentUserID: this.currentUser?.id,
      dataLength: tasks?.length || 0,
      error: tasksError?.message,
      sampleData: tasks?.slice(0, 2)
    });

    if(tasksError) {
      console.error('‚ùå Error fetching tasks:', tasksError);
      console.error('‚ùå Error details:', {
        message: tasksError.message,
        details: tasksError.details,
        hint: tasksError.hint,
        code: tasksError.code
      });
      
      // PERBAIKI: Jangan set unhealthy, coba query yang lebih sederhana
      console.log('üîÑ Trying simpler query...');
      const simpleQuery = window.supabaseClient
        .from('tasks')
        .select('id, user_id, created_at')
        .limit(10);
      
      if(!isAdmin) {
        simpleQuery.eq('user_id', this.currentUser.id);
      }
      
      const { data: simpleTasks, error: simpleError } = await simpleQuery;
      
      if(simpleError) {
        console.error('‚ùå Even simple query failed:', simpleError);
        window.supabaseHealthy = false;
        this.savedTasks = [];
        return;
      } else {
        console.log('‚úÖ Simple query worked, trying full data...');
        // Fetch satu per satu dengan field yang ada
        const detailedTasks = [];
        for(const task of simpleTasks) {
          const { data: fullTask, error: fullError } = await window.supabaseClient
            .from('tasks')
            .select('*')
            .eq('id', task.id)
            .single();
          
          if(!fullError && fullTask) {
            detailedTasks.push(fullTask);
          }
        }
        
        console.log('‚úÖ Fetched tasks individually:', detailedTasks.length);
        this.processFetchedTasks(detailedTasks, startTime);
        return;
      }
    }

    if(!tasks || tasks.length === 0) {
      this.savedTasks = [];
      console.log('üìù No tasks found in Supabase');
      this.clearCache();
      return;
    }

    console.log('üìù Raw tasks from Supabase:', tasks.length);
    console.log('üìù Raw tasks sample:', tasks.slice(0, 3).map(t => ({
      id: t.id,
      user_id: t.user_id,
      masalah: t.masalah,
      status_pekerjaan: t.status_pekerjaan
    })));
    
    this.processFetchedTasks(tasks, startTime);

  } catch (error) {
    console.error('‚ùå Critical error fetching tasks:', error);
    window.supabaseHealthy = false;
    this.savedTasks = [];
  }
},

// PERBAIKI: Extract task processing untuk reuse
processFetchedTasks(tasks, startTime) {
  console.log('üìù Raw tasks sample:', tasks.slice(0, 3).map(t => ({
    id: t.id,
    user_id: t.user_id,
    teknisi: t.teknisi,
    masalah: t.masalah,
    status_pekerjaan: t.status_pekerjaan
  })));

  // OPTIMASI: Map nama user dengan caching dan field compatibility
  console.log('üë• Available users for mapping:', this.registeredUsers.map(u => ({
    id: u.id,
    username: u.username,
    name: u.name
  })));

  const userMap = new Map(this.registeredUsers.map(u => [u.id, u]));
  const formattedData = tasks.map(task => {
    const user = userMap.get(task.user_id);
    
    // DEBUG: Log mapping result
    if (!user) {
      console.warn('‚ö†Ô∏è No user found for task user_id:', task.user_id);
    } else {
      console.log('‚úÖ User mapped:', {
        taskUserId: task.user_id,
        mappedUser: user.name,
        taskMasalah: task.masalah
      });
    }
    
    return {
      ...task,
      nama: user ? user.name : 'Unknown User',
      username: user ? user.username : 'unknown',
      // CRITICAL: Tambahkan field untuk compatibility dengan localStorage
      statusPekerjaan: task.status_pekerjaan
    };
  });

  this.savedTasks = formattedData;
  
  console.log('üîç DEBUG processFetchedTasks:', {
    savedTasksLength: this.savedTasks.length,
    currentUserRole: this.currentUser?.role,
    isAdmin: this.currentUser?.role === 'admin',
    sampleSavedTasks: this.savedTasks.slice(0, 2),
    allTaskUserIds: [...new Set(this.savedTasks.map(t => t.user_id))]
  });
  
  // PERBAIKI: Clear stats cache setelah data update
  this.clearStatsCache();
  
  // PERBAIKI: Handle localStorage quota error
  try {
    localStorage.setItem('upsrs_tasks_v3', JSON.stringify(this.savedTasks));
    console.log('üíæ Tasks saved to localStorage successfully');
  } catch (quotaError) {
    if (quotaError.name === 'QuotaExceededError') {
      console.warn('‚ö†Ô∏è localStorage quota exceeded, clearing old data...');
      // Clear old data and try again
      localStorage.removeItem('upsrs_tasks_v3');
      try {
        localStorage.setItem('upsrs_tasks_v3', JSON.stringify(this.savedTasks));
        console.log('üíæ Tasks saved after clearing old data');
      } catch (retryError) {
        console.error('‚ùå Still cannot save to localStorage, using memory only');
        // Continue without localStorage - data stays in memory
      }
    } else {
      console.error('‚ùå Error saving to localStorage:', quotaError);
    }
  }
  
  // OPTIMASI: Update cache
  const now = Date.now();
  this._cachedAllTasks = formattedData;
  this._cacheTimestamp = now;
  
  const endTime = performance.now();
  console.log(`‚úÖ Tasks fetched in ${(endTime - startTime).toFixed(2)}ms:`, formattedData.length);
  console.log('üìù Formatted tasks sample:', formattedData.slice(0, 3).map(t => ({
    id: t.id,
    user_id: t.user_id,
    nama: t.nama,
    status_pekerjaan: t.status_pekerjaan,
    statusPekerjaan: t.statusPekerjaan,
    tanggal: t.tanggal
  })));
},

// Clear cache function
clearCache(){
  this._cachedAllTasks = null;
  this._cacheTimestamp = null;
  console.log('üßπ Cache cleared');
},

// PERBAIKI: Clean localStorage untuk mengatasi quota issue
cleanLocalStorage() {
  try {
    const keys = Object.keys(localStorage);
    let totalSize = 0;
    
    // Calculate total size
    keys.forEach(key => {
      const value = localStorage.getItem(key);
      if (value) {
        totalSize += new Blob([value]).size;
      }
    });
    
    console.log('üìä localStorage usage:', (totalSize / 1024 / 1024).toFixed(2) + ' MB');
    
    // PERBAIKI: Lower threshold untuk mencegah error
    if (totalSize > 2 * 1024 * 1024) { // 2MB limit
      console.log('üßπ Cleaning localStorage to free space...');
      
      // Keep only essential data
      const essentialKeys = ['upsrs_current_user', 'upsrs_users_v3'];
      const essentialData = {};
      
      essentialKeys.forEach(key => {
        const value = localStorage.getItem(key);
        if (value) {
          essentialData[key] = value;
        }
      });
      
      // Clear everything
      localStorage.clear();
      
      // Restore essential data
      Object.keys(essentialData).forEach(key => {
        localStorage.setItem(key, essentialData[key]);
      });
      
      console.log('‚úÖ localStorage cleaned, essential data restored');
    } else {
      console.log('‚úÖ localStorage usage is OK');
    }
  } catch (error) {
    console.error('‚ùå Error cleaning localStorage:', error);
  }
},

// PERBAIKI: Force refresh stats untuk admin
forceRefreshStats() {
  console.log('üîÑ Force refreshing admin statistics...');
  
  // Clear cache untuk memastikan data fresh
  this.clearCache();
  
  // Re-sync dari Supabase
  if(this.currentUser?.role === 'admin') {
    this.syncFromSupabase().then(() => {
      console.log('üìä Admin stats after force refresh:', this.stats);
      console.log('üìä Admin detailed stats after refresh:', this.adminStats);
      
      // Debug statistik detail
      console.log('üìä Daily stats per user:', this.getDailyStatsPerUser());
      console.log('üìä Weekly stats per user:', this.getWeeklyStatsPerUser());
      console.log('üìä Monthly stats per user:', this.getMonthlyStatsPerUser());
    });
  }
},

// Ensure tasks table exists in Supabase
async ensureTasksTable(){
  try {
    console.log('üîß Checking if tasks table exists...');
    
    // Try to select from tasks table
    const { data, error } = await window.supabaseClient
      .from('tasks')
      .select('count')
      .limit(1);
    
    if(error && error.code === 'PGRST116') {
      // Table doesn't exist, create it
      console.log('üìù Creating tasks table...');
      
      const createTableSQL = `
        CREATE TABLE IF NOT EXISTS tasks (
          id BIGINT PRIMARY KEY,
          user_id TEXT NOT NULL,
          tanggal TEXT NOT NULL,
          waktu TEXT NOT NULL,
          teknisi TEXT NOT NULL,
          gedung TEXT NOT NULL,
          ruangan TEXT NOT NULL,
          pelapor TEXT,
          masalah TEXT NOT NULL,
          penyelesaian TEXT NOT NULL,
          statusPekerjaan TEXT NOT NULL,
          foto TEXT,
          created_at TIMESTAMP DEFAULT NOW()
        );
      `;
      
      const { error: createError } = await window.supabaseClient.rpc('exec_sql', { sql: createTableSQL });
      
      if(createError) {
        console.warn('‚ö†Ô∏è Could not create table automatically:', createError);
        console.log('üìã Please create table manually in Supabase dashboard');
      } else {
        console.log('‚úÖ Tasks table created successfully');
      }
    } else {
      console.log('‚úÖ Tasks table exists');
    }
  } catch(error) {
    console.warn('‚ö†Ô∏è Could not check table existence:', error);
  }
},

get regularUsers(){
  return this.registeredUsers.filter(u=>u.role!=='admin');
},

getAllUserTasks(){
try{
// Return cached result if available and fresh
if(this._cachedAllTasks && this._cacheTimestamp && (Date.now() - this._cacheTimestamp < 30000)){
  return this._cachedAllTasks;
}

const allTasks=[];
this.regularUsers.forEach(user=>{
  // BENAR: Gunakan user_id untuk filtering
  const userTasks=this.savedTasks.filter(task=>task.user_id===user.id);
  userTasks.forEach(task=>{
    allTasks.push({...task,userProfile:user.profile_photo,userRole:user.role});
  });
});

const sorted = allTasks.sort((a,b)=>{
  const dateA=dayjs(a.tanggal,'DD/MM/YYYY');
  const dateB=dayjs(b.tanggal,'DD/MM/YYYY');
  return dateB.isAfter(dateA)?1:-1;
});

// Cache dengan timestamp lebih lama (30 detik)
this._cachedAllTasks = sorted;
this._cacheTimestamp = Date.now();

return sorted;
}catch(error){
console.error('‚ùå Error in getAllUserTasks:', error);
return [];
}
},

// Get user statistics for admin dashboard
getUserStats(userId){
const user = this.registeredUsers.find(u => u.id === userId);
if(!user) return { totalTasks: 0, completedTasks: 0, pendingTasks: 0 };
// BENAR: Gunakan user_id untuk filtering
const userTasks = this.savedTasks.filter(t => t.user_id===user.id);
return{
totalTasks:userTasks.length,
completedTasks:userTasks.filter(t=>t.status_pekerjaan==='Selesai').length,
pendingTasks:userTasks.filter(t=>t.status_pekerjaan!=='Selesai').length
}
},

// Admin statistics getter
get adminStats(){
  // PERBAIKI: Gunakan cache untuk menghindari infinite loop
  return this.getCachedStats(() => {
    try {
      // PERBAIKI: Gunakan savedTasks langsung untuk admin, bukan getAllUserTasks()
      const allTasks = this.savedTasks; // Admin sudah lihat semua task
      const now = dayjs();
      
      // DEBUG: Log untuk memeriksa data
      console.log('üîç DEBUG adminStats:', {
        savedTasksLength: allTasks.length,
        sampleData: allTasks.slice(0, 2),
        currentUser: this.currentUser?.username,
        isAdmin: this.currentUser?.role === 'admin'
      });
      
      const stats = {
        todayTasks: allTasks.filter(t=>dayjs(t.tanggal,'DD/MM/YYYY').isSame(now,'day')).length,
        weeklyTasks: allTasks.filter(t=>dayjs(t.tanggal,'DD/MM/YYYY').isAfter(now.subtract(7,'day'))).length,
        thisWeekCompleted: allTasks.filter(t=>t.status_pekerjaan==='Selesai' && dayjs(t.tanggal,'DD/MM/YYYY').isAfter(now.subtract(7,'day'))).length,
        monthlyTasks: allTasks.filter(t=>dayjs(t.tanggal,'DD/MM/YYYY').isSame(now,'month')).length,
        thisMonthCompleted: allTasks.filter(t=>t.status_pekerjaan==='Selesai' && dayjs(t.tanggal,'DD/MM/YYYY').isSame(now,'month')).length
      };
      
      console.log('üìä Final admin stats:', stats);
      return stats;
      
    } catch(error) {
      console.error('Error in adminStats:', error);
      return {
        todayTasks: 0,
        weeklyTasks: 0,
        thisWeekCompleted: 0,
        monthlyTasks: 0,
        thisMonthCompleted: 0
      };
    }
  }, 'adminStats');
},

getAdminStats(){
// PERBAIKI: Gunakan savedTasks langsung untuk sinkronisasi yang benar
const allTasks = this.savedTasks; // Admin sudah lihat semua task
const now = dayjs();
return{
totalTasks: allTasks.length,
totalUsers: this.registeredUsers.length,
completedTasks: allTasks.filter(t=>t.status_pekerjaan==='Selesai').length,
pendingTasks: allTasks.filter(t=>t.status_pekerjaan!=='Selesai').length,
todayTasks: allTasks.filter(t=>dayjs(t.tanggal,'DD/MM/YYYY').isSame(now,'day')).length,
weeklyTasks: allTasks.filter(t=>dayjs(t.tanggal,'DD/MM/YYYY').isAfter(now.subtract(7,'day'))).length,
monthlyTasks:allTasks.filter(t=>dayjs(t.tanggal,'DD/MM/YYYY').isSame(now,'month')).length,
thisWeekCompleted:allTasks.filter(t=>t.status_pekerjaan==='Selesai' && dayjs(t.tanggal,'DD/MM/YYYY').isAfter(now.subtract(7,'day'))).length,
thisMonthCompleted:allTasks.filter(t=>t.status_pekerjaan==='Selesai' && dayjs(t.tanggal,'DD/MM/YYYY').isSame(now,'month')).length
};
},

// Get detailed daily stats per user
getDailyStatsPerUser(){
try{
// PERBAIKI: Gunakan savedTasks yang sudah sinkron dari Supabase
const allTasks = this.savedTasks;
const now = dayjs();
const today = now.format('DD/MM/YYYY');
const userStats = {};

console.log('üìä Calculating daily stats per user from savedTasks:', {
  totalTasks: allTasks.length,
  today: today,
  usersCount: this.registeredUsers.length
});

this.registeredUsers.forEach(user => {
  const userTasks = allTasks.filter(task => task.user_id === user.id && task.tanggal === today);
  userStats[user.id] = {
    userName: user.name,
    totalTasks: userTasks.length,
    completedTasks: userTasks.filter(t => t.status_pekerjaan === 'Selesai').length,
    pendingTasks: userTasks.filter(t => t.status_pekerjaan !== 'Selesai').length,
    tasks: userTasks
  };
  
  console.log(`üìä User ${user.name} daily stats:`, {
    userId: user.id,
    totalTasks: userTasks.length,
    completedTasks: userTasks.filter(t => t.status_pekerjaan === 'Selesai').length,
    pendingTasks: userTasks.filter(t => t.status_pekerjaan !== 'Selesai').length
  });
});

return userStats;
} catch(error){
  console.error('Error in getDailyStatsPerUser:', error);
  return {};
}
},

// Get detailed weekly stats per user
getWeeklyStatsPerUser(){
try{
// PERBAIKI: Gunakan savedTasks yang sudah sinkron dari Supabase
const allTasks = this.savedTasks;
const now = dayjs();
const userStats = {};

console.log('üìä Calculating weekly stats per user from savedTasks:', {
  totalTasks: allTasks.length,
  weekStart: now.subtract(7, 'day').format('DD/MM/YYYY'),
  usersCount: this.registeredUsers.length
});

this.registeredUsers.forEach(user => {
  const userTasks = allTasks.filter(task => task.user_id === user.id && dayjs(task.tanggal, 'DD/MM/YYYY').isAfter(now.subtract(7, 'day')));
  userStats[user.id] = {
    userName: user.name,
    totalTasks: userTasks.length,
    completedTasks: userTasks.filter(t => t.status_pekerjaan === 'Selesai').length,
    pendingTasks: userTasks.filter(t => t.status_pekerjaan !== 'Selesai').length,
    tasks: userTasks
  };
  
  console.log(`üìä User ${user.name} weekly stats:`, {
    userId: user.id,
    totalTasks: userTasks.length,
    completedTasks: userTasks.filter(t => t.status_pekerjaan === 'Selesai').length,
    pendingTasks: userTasks.filter(t => t.status_pekerjaan !== 'Selesai').length
  });
});

return userStats;
} catch(error){
  console.error('Error in getWeeklyStatsPerUser:', error);
  return {};
}
},

// Get detailed monthly stats per user
getMonthlyStatsPerUser(){
try{
// PERBAIKI: Gunakan savedTasks yang sudah sinkron dari Supabase
const allTasks = this.savedTasks;
const now = dayjs();
const userStats = {};

console.log('üìä Calculating monthly stats per user from savedTasks:', {
  totalTasks: allTasks.length,
  currentMonth: now.format('MMMM YYYY'),
  usersCount: this.registeredUsers.length
});

this.registeredUsers.forEach(user => {
  const userTasks = allTasks.filter(task => task.user_id === user.id && dayjs(task.tanggal, 'DD/MM/YYYY').isSame(now, 'month'));
  userStats[user.id] = {
    userName: user.name,
    totalTasks: userTasks.length,
    completedTasks: userTasks.filter(t => t.status_pekerjaan === 'Selesai').length,
    pendingTasks: userTasks.filter(t => t.status_pekerjaan !== 'Selesai').length,
    tasks: userTasks
  };
  
  console.log(`üìä User ${user.name} monthly stats:`, {
    userId: user.id,
    totalTasks: userTasks.length,
    completedTasks: userTasks.filter(t => t.status_pekerjaan === 'Selesai').length,
    pendingTasks: userTasks.filter(t => t.status_pekerjaan !== 'Selesai').length
  });
});

return userStats;
} catch(error){
  console.error('Error in getMonthlyStatsPerUser:', error);
  return {};
}
},

// Get weekly stats by week number (1-4)
getWeeklyStatsByWeek(){
try{
// PERBAIKI: Gunakan savedTasks yang sudah sinkron dari Supabase
const allTasks = this.savedTasks;
const now = dayjs();
const currentMonth = now.month();
const currentYear = now.year();
const weekStats = {};

console.log('üìä Calculating weekly stats by week from savedTasks:', {
  totalTasks: allTasks.length,
  currentMonth: now.format('MMMM'),
  currentYear: currentYear,
  usersCount: this.registeredUsers.length
});

// Initialize weeks 1-4
for(let i = 1; i <= 4; i++){
  weekStats[i] = {
    weekNumber: i,
    userStats: {},
    totalTasks: 0,
    totalCompleted: 0
  };
}

this.registeredUsers.forEach(user => {
  // Initialize user stats for each week
  for(let i = 1; i <= 4; i++){
    weekStats[i].userStats[user.id] = {
      userName: user.name,
      totalTasks: 0,
completedTasks:0,
pendingTasks:0
};
}
});

allTasks.forEach(task=>{
const taskDate=dayjs(task.tanggal,'DD/MM/YYYY');
if(taskDate.month()===currentMonth && taskDate.year()===currentYear){
// Calculate week number (1-4)
const firstDayOfMonth=taskDate.startOf('month');
const dayOfMonth=taskDate.date();
const weekNumber=Math.ceil((dayOfMonth + firstDayOfMonth.day())/7);
const adjustedWeekNumber=Math.min(weekNumber,4); // Cap at 4

if(weekStats[adjustedWeekNumber] && weekStats[adjustedWeekNumber].userStats[task.user_id]){
weekStats[adjustedWeekNumber].userStats[task.user_id].totalTasks++;
weekStats[adjustedWeekNumber].totalTasks++;
if(task.status_pekerjaan==='Selesai'){
weekStats[adjustedWeekNumber].userStats[task.user_id].completedTasks++;
weekStats[adjustedWeekNumber].totalCompleted++;
}else{
weekStats[adjustedWeekNumber].userStats[task.user_id].pendingTasks++;
}
}
}
});

return weekStats;
}catch(error){
console.error('Error in getWeeklyStatsByWeek:', error);
return{};
}
},

// Force refresh admin stats
refreshAdminStats(){
// This function will be called to force reactivity
return this.getAdminStats();
},

// Enhanced export for admin
async exportAllTasksToExcel(){
// PERBAIKI: Gunakan savedTasks langsung untuk admin
const allTasks = this.savedTasks;
if(allTasks.length===0)return alert('Tidak ada data untuk diexport');
this.isExporting=true;
try{
console.log('üìä Admin exporting all tasks:', allTasks.length);
const wb=new ExcelJS.Workbook();
const ws=wb.addWorksheet('Semua Laporan User');
ws.columns=[
{header:'ID',key:'id',width:10},
{header:'User ID',key:'user_id',width:15},
{header:'Nama User',key:'nama',width:20},
{header:'Username',key:'username',width:15},
{header:'Tanggal',key:'tanggal',width:15},
{header:'Waktu',key:'waktu',width:12},
{header:'Teknisi',key:'teknisi',width:20},
{header:'Gedung',key:'gedung',width:20},
{header:'Ruangan',key:'ruangan',width:25},
{header:'Pelapor',key:'pelapor',width:20},
{header:'Permasalahan',key:'masalah',width:40},
{header:'Penyelesaian',key:'penyelesaian',width:40},
{header:'Status',key:'statusPekerjaan',width:15},
{header:'Foto',key:'foto',width:20}
];

ws.getRow(1).font={bold:true};
ws.getRow(1).height=20;

for(let i=0;i<allTasks.length;i++){
const task=allTasks[i];
const row=ws.addRow({
id:task.id,
user_id:task.user_id,
nama:task.nama || 'Unknown',
username:task.username || 'unknown',
tanggal:task.tanggal,
waktu:task.waktu,
teknisi:task.teknisi || task.nama || 'Unknown',
gedung:task.gedung,
ruangan:task.ruangan,
pelapor:task.pelapor||'-',
masalah:task.masalah||'-',
penyelesaian:task.penyelesaian||'-',
// PERBAIKI: Gunakan field yang compatible
statusPekerjaan:task.statusPekerjaan || task.status_pekerjaan || 'Unknown',
foto:task.foto?'Ada':'Tidak Ada'
});

row.height=task.foto?80:20;

if(task.foto){
try{
let base64Data=task.foto;
if(base64Data.includes(','))base64Data=base64Data.split(',')[1];
const binaryString=atob(base64Data);
const bytes=new Uint8Array(binaryString.length);
for(let j=0;j<binaryString.length;j++)bytes[j]=binaryString.charCodeAt(j);
const imageId=wb.addImage({buffer:bytes,extension:'jpeg'});
ws.addImage(imageId,{tl:{col:13,row:i+2},ext:{width:120,height:90}});
const fotoCell=row.getCell(14);
fotoCell.alignment={vertical:'middle',horizontal:'center'};
}catch(e){console.error('Error adding image:',e);}
}
}

const buffer=await wb.xlsx.writeBuffer();
const blob=new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
saveAs(blob,`Laporan_Admin_Keseluruhan_${dayjs().format('YYYYMMDD_HHmm')}.xlsx`);
console.log('‚úÖ Admin Excel exported successfully');
}catch(e){
console.error('‚ùå Admin export error:', e);
alert('Gagal export: '+e.message);
}finally{
this.isExporting=false;
}
},

// PERBAIKI: Bersihkan file dari kode duplikat
logout(){
localStorage.removeItem('upsrs_current_user');
this.currentUser=null;
this.page='login';
},

// Google Drive Upload Function
async uploadToGoogleDrive(blob,filename){
try{
// Create a file input element to trigger download
const file=new File([blob],filename,{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});

// Create a temporary download link
const url=URL.createObjectURL(file);
const a=document.createElement('a');
a.href=url;
a.download=filename;

// Show instruction for Google Drive upload
alert(`File Excel telah diunduh!\n\nUntuk upload ke Google Drive:\n1. Buka Google Drive (drive.google.com)\n2. Klik tombol "+ New"\n3. Pilih "File upload"\n4. Pilih file yang telah diunduh: ${filename}\n\nFile tersimpan di folder Downloads Anda.`);

// Trigger download
a.click();
URL.revokeObjectURL(url);

}catch(e){
console.error('Upload error:',e);
alert('Terjadi kesalahan saat upload ke Google Drive');
}
},

// Edit pending task to completed
editPendingTask(task){
this.editingTask={
...task,
originalStatus:task.statusPekerjaan,
originalPenyelesaian:task.penyelesaian,
newPenyelesaian:task.statusPekerjaan==='Selesai'?task.penyelesaian:''
};
this.page='editPendingTask';
},

// Save edited pending task
async saveEditedTask(){
if(!this.editingTask.newPenyelesaian||!this.editingTask.newPenyelesaian.trim()){
return alert('Isi penyelesaian pekerjaan!');
}

const taskIndex=this.savedTasks.findIndex(t=>t.id===this.editingTask.id);
if(taskIndex!==-1){
// Update task data
const updatedTask={
...this.savedTasks[taskIndex],
statusPekerjaan:'Selesai',
penyelesaian:this.editingTask.newPenyelesaian,
waktuSelesai:dayjs().format('HH:mm'),
tanggalSelesai:dayjs().format('DD/MM/YYYY')
};

// Try to update in Supabase first (if online)
if(window.supabaseClient && navigator.onLine) {
  try {
    console.log('üîÑ Updating task in Supabase:', this.editingTask.id);
    const { error } = await window.supabaseClient
      .from('tasks')
      .update({
        status_pekerjaan: 'Selesai',
        penyelesaian: this.editingTask.newPenyelesaian,
        waktu_selesai: dayjs().format('HH:mm'),
        tanggal_selesai: dayjs().format('DD/MM/YYYY')
      })
      .eq('id', this.editingTask.id);
    
    if(error) {
      console.warn('‚ö†Ô∏è Failed to update task in Supabase, updating localStorage only:', error);
      alert('‚ö†Ô∏è Gagal update di server, mengupdate local storage saja.');
    } else {
      console.log('‚úÖ Task updated in Supabase successfully');
    }
  } catch(supabaseError) {
    console.warn('‚ö†Ô∏è Supabase update error, updating localStorage only:', supabaseError);
    alert('‚ö†Ô∏è Tidak ada koneksi, mengupdate local storage saja.');
  }
} else {
  console.log('üìä Offline mode - updating localStorage only');
}

// Always update localStorage
this.savedTasks[taskIndex]=updatedTask;
localStorage.setItem('upsrs_tasks_v3',JSON.stringify(this.savedTasks));

// Clear cache to refresh data
this.clearCache();

alert('Status pekerjaan berhasil diperbarui!');

// Redirect based on user role
if(this.currentUser?.username==='Admin' && this.currentUser?.role==='admin'){
this.page='userReports';
}else{
this.page='dashboard';
}
this.editingTask=null;
}
},

// Get user reports for viewing
getUserReports(userId){
const user=this.registeredUsers.find(u=>u.id===userId);
if(!user)return [];
// BENAR: Gunakan user_id untuk filtering, bukan teknisi
return this.savedTasks.filter(task=>task.user_id===user.id).sort((a,b)=>{
const dateA=dayjs(a.tanggal,'DD/MM/YYYY');
const dateB=dayjs(b.tanggal,'DD/MM/YYYY');
return dateB.isAfter(dateA)?1:-1;
});
},

// Reset all user work
resetAllUserWork(){
if(!confirm('Apakah Anda yakin ingin menghapus SEMUA pekerjaan user? Tindakan ini tidak dapat dibatalkan!'))return;
this.savedTasks=[];
localStorage.setItem('upsrs_tasks_v3',JSON.stringify(this.savedTasks));
alert('Semua pekerjaan user telah direset!');
},

// Reset all accounts (keep only Super Admin)
resetAllAccounts(){
if(!confirm('Apakah Anda yakin ingin menghapus SEMUA akun user? Hanya Super Admin yang akan tersisa! Tindakan ini tidak dapat dibatalkan!'))return;
this.registeredUsers=this.registeredUsers.filter(u=>u.username==='Admin');
localStorage.setItem('upsrs_users_v3',JSON.stringify(this.registeredUsers));
alert('Semua akun user telah direset! Hanya Super Admin yang tersisa.');
},

// Edit user credentials
editUserCredentials(userId){
const user=this.registeredUsers.find(u=>u.id===userId);
if(!user)return;

const newUsername=prompt('Username baru:',user.username);
const newPassword=prompt('Password baru:',user.password);

if(newUsername && newPassword){
const userIndex=this.registeredUsers.findIndex(u=>u.id===userId);
if(userIndex!==-1){
const oldName = this.registeredUsers[userIndex].name;

this.registeredUsers[userIndex]={
...this.registeredUsers[userIndex],
username:newUsername,
password:newPassword
};

// Update localStorage
localStorage.setItem('upsrs_users_v3',JSON.stringify(this.registeredUsers));

// Clear cache untuk refresh data
this.clearCache();

alert('Kredensial user berhasil diperbarui!');
}
}
},

// Refresh user list for Super Admin
refreshUserList(){
this.registeredUsers=JSON.parse(localStorage.getItem('upsrs_users_v3')||'[]');
alert('Daftar user berhasil diperbarui!');
},

// Refresh tasks list for Super Admin
async refreshTasks(){
await this.fetchTasks();
alert('Daftar laporan berhasil diperbarui!');
},
// Combined refresh function for real server refresh only
async refreshAllData(){
console.log('üöÄ Starting fast server refresh...');
const startTime = performance.now();
try {
  // Clear cache first
  this.clearCache();
  
  // Test connection first
  if(!window.supabaseClient || !navigator.onLine) {
    alert('‚ùå Tidak ada koneksi internet. Admin harus online untuk refresh data.');
    return;
  }
  
  // PARALLEL FETCHING - lebih cepat
  console.log('‚ö° Parallel fetching users and tasks...');
  const [usersResult, tasksResult] = await Promise.allSettled([
    this.fetchUsers(),
    this.fetchTasks()
  ]);
  
  const endTime = performance.now();
  console.log(`‚úÖ Fast refresh completed in ${(endTime - startTime).toFixed(2)}ms`);
  
  // Check results
  let message = 'üîÑ Data berhasil diperbarui dari server!\n\n';
  message += '‚úÖ Mode Online\n';
  message += `üìù Total Laporan: ${this.savedTasks.length}\n`;
  message += `üë§ Total User: ${this.registeredUsers.length}\n`;
  message += `‚ö° Waktu: ${(endTime - startTime).toFixed(2)}ms`;
  
  alert(message);
        
} catch(error) {
  console.error('‚ùå Server refresh error:', error);
  alert('‚ùå Gagal refresh data dari server: ' + error.message);
}
},

// Force sync data from localStorage and clear cache
forceSyncData(){
console.log('üîÑ Force syncing data...');
try {
  // Force reload from localStorage
  this.savedTasks = JSON.parse(localStorage.getItem('upsrs_tasks_v3')||'[]');
  this.registeredUsers = JSON.parse(localStorage.getItem('upsrs_users_v3')||'[]');
  
  // Clear all caches
  this._cachedAllTasks = null;
  this._cacheTimestamp = null;
  
  console.log('‚úÖ Force sync completed');
  console.log('üìù Tasks loaded:', this.savedTasks.length);
  console.log('üë§ Users loaded:', this.registeredUsers.length);
  
  // Show task details for debugging
  if(this.savedTasks.length > 0) {
    console.log('üìã Task samples:', this.savedTasks.slice(0, 3).map(t => ({
      id: t.id,
      teknisi: t.teknisi,
      tanggal: t.tanggal,
      masalah: t.masalah?.substring(0, 50) + '...'
    })));
  }
  
  alert('üîÑ Data berhasil disinkronkan dari localStorage!\n\n' +
        'üìù Total Laporan: ' + this.savedTasks.length + '\n' +
        'üë§ Total User: ' + this.registeredUsers.length);
        
} catch(error) {
  console.error('‚ùå Force sync error:', error);
  alert('‚ùå Gagal sinkronisasi data: ' + error.message);
}
},

// Debug function to check data consistency
debugData(){
console.log('=== DEBUG DATA ===');
console.log('Current User:', this.currentUser);
console.log('Registered Users:', this.registeredUsers.length);
console.log('Regular Users:', this.regularUsers.length);
console.log('Saved Tasks:', this.savedTasks.length);
console.log('All User Tasks:', this.getAllUserTasks().length);
console.log('Task Sample:', this.savedTasks.slice(0, 2));
console.log('User Sample:', this.regularUsers.slice(0, 2));
console.log('Supabase Available:', !!window.supabaseClient);
console.log('Online Mode:', navigator.onLine);
alert('Debug data logged to console. Check F12 > Console.');
},

// Test connection and sync status
testConnection(){
console.log('=== CONNECTION TEST ===');
console.log('Navigator Online:', navigator.onLine);
console.log('Supabase Client:', !!window.supabaseClient);

if(window.supabaseClient && navigator.onLine) {
  console.log('Testing Supabase connection...');
  window.supabaseClient
    .from('users')
    .select('count')
    .then(({ data, error }) => {
      if(error) {
        console.error('‚ùå Supabase connection failed:', error);
        alert('‚ùå Supabase connection failed. Using offline mode.');
      } else {
        console.log('‚úÖ Supabase connection successful');
        alert('‚úÖ Supabase connection successful');
      }
    });
} else {
  console.log('üìä Working in offline mode');
  alert('üìä Working in offline mode');
}
},

// View user profile (simple view)
viewUserProfile(user){
this.viewingUser=user;
this.page='profile';
},

// View current user's own profile
viewMyProfile(){
this.viewingUser=this.currentUser;
this.page='profile';
},

// View user profile with all tasks
viewUserProfileWithTasks(user){
this.viewingUser=user;
this.editingUserProfile={
...user,
newName:user.name,
newUsername:user.username,
newPassword:user.password,
newSpecialization:user.specialization||''
};
this.page='userProfileWithTasks';
},

// Save edited user profile
saveEditedUserProfile(){
if(!this.editingUserProfile.newName||!this.editingUserProfile.newUsername||!this.editingUserProfile.newPassword){
return alert('Lengkapi semua data profil!');
}

const userIndex=this.registeredUsers.findIndex(u=>u.id===this.viewingUser.id);
if(userIndex!==-1){
const oldName = this.registeredUsers[userIndex].name;
const newName = this.editingUserProfile.newName;

// Update user data
this.registeredUsers[userIndex]={
...this.registeredUsers[userIndex],
name:this.editingUserProfile.newName,
username:this.editingUserProfile.newUsername,
password:this.editingUserProfile.newPassword,
specialization:this.editingUserProfile.newSpecialization
};

// Update nama teknisi di semua laporan user ini
if(oldName !== newName) {
  this.savedTasks.forEach(task => {
    if(task.user_id === this.viewingUser.id) {
      // Update teknisi field untuk backward compatibility
      task.teknisi = newName;
    }
  });
  console.log(`‚úÖ Updated teknisi name from "${oldName}" to "${newName}" in ${this.savedTasks.filter(t => t.user_id === this.viewingUser.id).length} tasks`);
}

// Update localStorage
localStorage.setItem('upsrs_users_v3',JSON.stringify(this.registeredUsers));
localStorage.setItem('upsrs_tasks_v3',JSON.stringify(this.savedTasks));

// Update viewingUser
this.viewingUser=this.registeredUsers[userIndex];

// Clear cache untuk refresh data
this.clearCache();

alert('Profil user berhasil diperbarui!' + (oldName !== newName ? '\n\n‚úÖ Nama di semua laporan juga telah diperbarui!' : ''));
}
},

// Get all tasks for a specific user (both pending and completed)
getUserAllTasks(userId){
const user=this.registeredUsers.find(u=>u.id===userId);
if(!user)return [];
// BENAR: Gunakan user_id untuk filtering, bukan teknisi
return this.savedTasks.filter(task=>task.user_id===user.id).sort((a,b)=>{
const dateA=dayjs(a.tanggal,'DD/MM/YYYY');
const dateB=dayjs(b.tanggal,'DD/MM/YYYY');
return dateB.isAfter(dateA)?1:-1;
});
},

// Delete individual task
async deleteTask(taskId){
if(!confirm('Apakah Anda yakin ingin menghapus laporan ini? Tindakan ini tidak dapat dibatalkan!'))return;

// Find and remove task
const taskIndex = this.savedTasks.findIndex(t => t.id === taskId);
if(taskIndex !== -1){
  const deletedTask = this.savedTasks[taskIndex];
  
  // Try to delete from Supabase first (if online)
  if(window.supabaseClient && navigator.onLine) {
    try {
      console.log('üóëÔ∏è Deleting task from Supabase:', taskId);
      const { error } = await window.supabaseClient
        .from('tasks')
        .delete()
        .eq('id', taskId);
      
      if(error) {
        console.warn('‚ö†Ô∏è Failed to delete from Supabase, removing from localStorage only:', error);
        alert('‚ö†Ô∏è Gagal menghapus dari server, menghapus dari local storage saja.');
      } else {
        console.log('‚úÖ Task deleted from Supabase successfully');
      }
    } catch(supabaseError) {
      console.warn('‚ö†Ô∏è Supabase delete error, removing from localStorage only:', supabaseError);
      alert('‚ö†Ô∏è Tidak ada koneksi, menghapus dari local storage saja.');
    }
  } else {
    console.log('üìä Offline mode - deleting from localStorage only');
  }
  
  // Always remove from localStorage
  this.savedTasks.splice(taskIndex, 1);
  
  // Update localStorage
  localStorage.setItem('upsrs_tasks_v3', JSON.stringify(this.savedTasks));
  
  // Clear cache to refresh data
  this.clearCache();
  
  alert(`Laporan "${deletedTask.ruangan} - ${deletedTask.gedung}" berhasil dihapus!`);
} else {
  alert('Laporan tidak ditemukan!');
}
},

// Delete user and all their tasks
async deleteUser(userId){
if(!confirm('Apakah Anda yakin ingin menghapus user ini? Semua laporan user ini juga akan dihapus! Tindakan ini tidak dapat dibatalkan!'))return;

// Get user info before deletion
const user=this.registeredUsers.find(u=>u.id===userId);
if(!user)return;

// Try to delete from Supabase first (if online)
if(window.supabaseClient && navigator.onLine) {
  try {
    console.log('üóëÔ∏è Deleting user tasks from Supabase for user:', userId);
    const { error: taskError } = await window.supabaseClient
      .from('tasks')
      .delete()
      .eq('user_id', userId);
    
    if(taskError) {
      console.warn('‚ö†Ô∏è Failed to delete user tasks from Supabase:', taskError);
      alert('‚ö†Ô∏è Gagal menghapus laporan dari server, menghapus dari local storage saja.');
    } else {
      console.log('‚úÖ User tasks deleted from Supabase successfully');
    }
  } catch(supabaseError) {
    console.warn('‚ö†Ô∏è Supabase delete error, removing from localStorage only:', supabaseError);
    alert('‚ö†Ô∏è Tidak ada koneksi, menghapus dari local storage saja.');
  }
} else {
  console.log('üìä Offline mode - deleting from localStorage only');
}

// Remove user from registered users
this.registeredUsers=this.registeredUsers.filter(u=>u.id!==userId);

// Remove all tasks associated with this user - BENAR: Gunakan user_id
this.savedTasks=this.savedTasks.filter(task=>task.user_id!==user.id);

// Update localStorage
localStorage.setItem('upsrs_users_v3',JSON.stringify(this.registeredUsers));
localStorage.setItem('upsrs_tasks_v3',JSON.stringify(this.savedTasks));

// Clear cache to refresh data
this.clearCache();

alert(`User "${user.name}" dan semua laporannya berhasil dihapus!`);
},

// WhatsApp Share Function
shareToWhatsApp(task){
// Get teknisi name from user data
const user = this.registeredUsers.find(u => u.id === task.user_id);
const teknisiName = user ? user.name : 'Unknown';

let message=`üîß *LAPORAN PEKERJAAN UPSRS*\n\n`;
message+=`üìÖ *Tanggal:* ${task.tanggal} ${task.waktu}\n`;
message+=`üë§ *Teknisi:* ${teknisiName}\n`;
message+=`üè¢ *Lokasi:* ${task.gedung} - ${task.ruangan}\n`;
message+=`üìã *Pelapor:* ${task.pelapor||'-'}\n\n`;
message+=`‚ùå *PERMASALAHAN:*\n${task.masalah}\n\n`;

// Always show status information - both original and current if available
if(task.tanggalSelesai && task.waktuSelesai && task.originalStatus === 'Belum Selesai'){
// Task was edited from pending to completed - show BOTH statuses completely
message+=`‚ö†Ô∏è *STATUS AWAL: BELUM SELESAI*\n`;
message+=`üìù *Alasan Pending (Lama):*\n${task.originalPenyelesaian}\n\n`;
message+=`üìÖ *Waktu Pending:* ${task.tanggal} ${task.waktu}\n\n`;
message+=`‚úÖ *STATUS SEKARANG: SELESAI*\n`;
message+=`üìù *Penyelesaian:*\n${task.penyelesaian}\n\n`;
message+=`üìÖ *Waktu Selesai:* ${task.tanggalSelesai} ${task.waktuSelesai}\n`;
}else if(task.status_pekerjaan === 'Belum Selesai' || task.statusPekerjaan === 'Belum Selesai'){
// Task is still pending - check both field names
message+=`‚ö†Ô∏è *STATUS:* Belum Selesai\n`;
message+=`üìù *Alasan Pending:* ${task.penyelesaian}\n`;
message+=`üìÖ *Waktu:* ${task.tanggal} ${task.waktu}\n`;
}else{
// Task was originally completed (no status change)
message+=`‚úÖ *STATUS:* Selesai\n`;
message+=`üìù *Penyelesaian:* ${task.penyelesaian}\n`;
message+=`üìÖ *Waktu:* ${task.tanggal} ${task.waktu}\n`;
}

message+=`\nüì∏ *Foto:* ${task.foto?'Ada':'Tidak ada'}`;

const whatsappUrl=`https://wa.me/?text=${encodeURIComponent(message)}`;
window.open(whatsappUrl,'_blank');
},

// Profile Management
async updateProfile(){
if(!this.newUserProfile.name||!this.newUserProfile.username||!this.newUserProfile.password){
return alert('Lengkapi semua data!');
}

try{
  // Try Supabase first if available
  if (window.supabaseClient) {
    const { error } = await window.supabaseClient
      .from('users')
      .update({
        name:this.newUserProfile.name,
        username:this.newUserProfile.username,
        password:this.newUserProfile.password,
        specialization:this.newUserProfile.specialization || '',
        profile_photo:this.newUserProfile.profilePhoto
      })
      .eq('id', this.currentUser.id);

    if(error){
      throw error;
    }
  }

  // Update localStorage (always update for offline mode)
  const userIndex = this.registeredUsers.findIndex(u => u.id === this.currentUser.id);
  if(userIndex !== -1){
    this.registeredUsers[userIndex] = {
      ...this.registeredUsers[userIndex],
      name:this.newUserProfile.name,
      username:this.newUserProfile.username,
      password:this.newUserProfile.password,
      specialization:this.newUserProfile.specialization || '',
      profile_photo:this.newUserProfile.profilePhoto
    };
    
    // Update current user
    this.currentUser = this.registeredUsers[userIndex];
    localStorage.setItem('upsrs_current_user', JSON.stringify(this.currentUser));
    localStorage.setItem('upsrs_users_v3', JSON.stringify(this.registeredUsers));
    
    console.log('‚úÖ Profile updated in localStorage');
  }

  // Refresh users list if admin
  if(this.currentUser.role === 'admin'){
    await this.fetchUsers();
  }

  alert('Profil berhasil diperbarui!');
  this.page='profile';

}catch(err){
console.error('Update profile error:', err);
alert('Gagal update profil: ' + err.message);
}
},

base64ToBlob(base64) {
  const parts = base64.split(',');
  const mime = parts[0].match(/:(.*?);/)[1];
  const bstr = atob(parts[1]);
  let n = bstr.length;
  const u8arr = new Uint8Array(n);
  while (n--) {
    u8arr[n] = bstr.charCodeAt(n);
  }
  return new Blob([u8arr], { type: mime });
}

} // Penutup function base64ToBlob

} // Penutup function appData}
</script>
</head>

<body x-data="appData()" x-init="initApp()" x-cloak class="antialiased">

<!-- LOGIN -->
<div x-show="page==='login'" class="min-h-screen flex items-center justify-center bg-slate-50 p-4">
<div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-xl border border-slate-100">
<div class="text-center mb-6">
<h1 class="text-3xl font-black text-slate-800">UPSRS <span class="text-blue-600">GO!</span></h1>
<p class="text-xs text-slate-400 uppercase tracking-wider">Maintenance System</p>
</div>
<div class="space-y-4">
<input x-model="authUsername" type="text" class="input-style" placeholder="Username">
<div class="relative">
<input x-model="authPassword" :type="showPass?'text':'password'" class="input-style pr-12" placeholder="Password">
<button @click="showPass=!showPass" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
</button>
</div>
<button @click="handleLogin" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition">MASUK</button>
<button @click="page='adminLogin'" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700 transition mt-2">MASUK SEBAGAI ADMIN</button>
<button @click="page='register'" class="w-full text-xs text-slate-500 mt-3 hover:text-blue-600">Belum punya akun? Daftar</button>
</div>
</div>
</div>

<!-- REGISTER -->
<div x-show="page==='register'" class="min-h-screen flex items-center justify-center bg-slate-50 p-4">
<div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-xl border border-slate-100">
<div class="text-center mb-6">
<h1 class="text-3xl font-black text-slate-800">UPSRS <span class="text-blue-600">GO!</span></h1>
<p class="text-xs text-slate-400 uppercase tracking-wider">Daftar Akun Baru</p>
</div>

<!-- Connection Status Indicator -->
<div class="mb-4 p-3 rounded-lg text-center text-xs font-bold" 
     :class="window.supabaseHealthy ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
  <span x-text="window.supabaseHealthy ? 'üü¢ ONLINE - Supabase Connected' : 'üî¥ OFFLINE - Local Storage Mode'"></span>
</div>

<div class="mb-4">
<input x-model="authName" type="text" class="input-style" placeholder="Nama Lengkap">
</div>
<div class="mb-4">
<input x-model="authUsername" type="text" class="input-style" placeholder="Username">
</div>
<div class="mb-4">
<input x-model="authSpecialization" type="text" class="input-style" placeholder="Bidang/Bagian Teknisi (opsional)">
</div>
<div class="relative mb-4">
<input x-model="authPassword" :type="showPass?'text':'password'" class="input-style pr-12" placeholder="Password">
<button @click="showPass=!showPass" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
</button>
</div>
<div class="mb-4">
<label class="block text-xs font-bold text-slate-600 mb-2">Foto Profil (opsional)</label>
<label class="block w-full h-24 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer overflow-hidden">
<template x-if="!authProfilePhoto">
<div class="text-center">
<svg class="w-8 h-8 mx-auto text-slate-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
<p class="text-xs text-slate-500">Klik untuk upload foto</p>
</div>
</template>
<template x-if="authProfilePhoto">
<img :src="authProfilePhoto" class="w-full h-full object-cover">
</template>
<input type="file" accept="image/*" class="hidden" @change="handleProfilePhotoUpload">
</label>
</div>
<button @click="handleRegister" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition">DAFTAR</button>
<button @click="testSupabaseRegistration" class="w-full bg-orange-500 text-white py-3 rounded-xl font-bold hover:bg-orange-600 transition mt-2">üîç TEST DEBUG REGISTRATION</button>
<button @click="forceReconnectSupabase" class="w-full bg-purple-500 text-white py-3 rounded-xl font-bold hover:bg-purple-600 transition mt-2">üîÑ FORCE RECONNECT SUPABASE</button>
<button @click="page='adminLogin'" class="w-full bg-purple-600 text-white py-3 rounded-xl font-bold hover:bg-purple-700 transition mt-2">MASUK SEBAGAI ADMIN</button>
<button @click="page='login'" class="w-full text-xs text-slate-500 mt-3 hover:text-blue-600">Sudah punya akun? Login</button>
</div>
</div>
</div>

<!-- ADMIN LOGIN -->
<div x-show="page==='adminLogin'" class="min-h-screen flex items-center justify-center bg-slate-50 p-4">
<div class="bg-white p-8 rounded-3xl w-full max-w-sm shadow-xl border border-slate-100">
<div class="text-center mb-6">
<h1 class="text-3xl font-black text-purple-800">UPSRS <span class="text-purple-600">ADMIN</span></h1>
<p class="text-xs text-slate-400 uppercase tracking-wider">Administrator Login</p>
</div>
<div class="space-y-4">
<input x-model="authUsername" type="text" class="input-style" placeholder="Admin Username">
<div class="relative">
<input x-model="authPassword" :type="showPass?'text':'password'" class="input-style pr-12" placeholder="Admin Password">
<button @click="showPass=!showPass" class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400">
<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path></svg>
</button>
</div>
<button @click="handleAdminLogin" class="w-full bg-purple-600 text-white py-4 rounded-xl font-bold hover:bg-purple-700 transition">MASUK ADMIN</button>
<button @click="page='login'" class="w-full text-xs text-slate-500 mt-3 hover:text-purple-600">Kembali ke Login User</button>
</div>
</div>
</div>

<!-- DASHBOARD -->
<div x-show="page==='dashboard'" class="max-w-md mx-auto p-4 pb-24">
<!-- Header -->
<div class="flex justify-between items-center mb-6 bg-white p-4 rounded-2xl shadow-sm border border-slate-100">
<div class="flex items-center gap-3">
<div class="w-12 h-12 bg-slate-100 rounded-full overflow-hidden">
<template x-if="currentUser?.profile_photo"><img :src="currentUser.profile_photo" class="w-full h-full object-cover"></template>
<template x-if="!currentUser?.profile_photo"><div class="w-full h-full flex items-center justify-center text-slate-400 text-xs">No Photo</div></template>
</div>
<div>
<h2 class="font-black text-lg" x-text="currentUser?.name"></h2>
<p class="text-xs text-slate-400" x-text="isAdmin?'Administrator':'Teknisi'"></p>
</div>
</div>
<div class="flex gap-2">
<button @click="viewMyProfile()" class="px-3 py-2 bg-blue-100 text-blue-600 rounded-xl text-sm font-bold hover:bg-blue-200">Profil</button>
<template x-if="isAdmin">
<button @click="page='admin'" class="px-3 py-2 bg-purple-100 text-purple-600 rounded-xl text-sm font-bold hover:bg-purple-200">Admin</button>
</template>
<button @click="logout" class="px-4 py-2 bg-red-100 text-red-600 rounded-xl text-sm font-bold hover:bg-red-200">Logout</button>
</div>
</div>

<!-- Stats -->
<div class="bg-white p-5 rounded-2xl mb-6 shadow-sm border border-slate-100">
<div class="flex gap-2 mb-4 p-1 bg-slate-50 rounded-xl">
<button @click="filterPeriod='all'" :class="filterPeriod==='all'?'bg-white shadow text-blue-600':'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold">Semua</button>
<button @click="filterPeriod='today'" :class="filterPeriod==='today'?'bg-white shadow text-blue-600':'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold">Hari</button>
<button @click="filterPeriod='week'" :class="filterPeriod==='week'?'bg-white shadow text-blue-600':'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold">Minggu</button>
<button @click="filterPeriod='month'" :class="filterPeriod==='month'?'bg-white shadow text-blue-600':'text-slate-400'" class="flex-1 py-2 rounded-lg text-xs font-bold">Bulan</button>
</div>
<div class="grid grid-cols-3 gap-4 text-center">
<div>
<p class="text-2xl font-black text-slate-800" x-text="stats.total"></p>
<p class="text-xs text-slate-400 uppercase">Total</p>
</div>
<div>
<p class="text-2xl font-black text-emerald-600" x-text="stats.selesai"></p>
<p class="text-xs text-slate-400 uppercase">Selesai</p>
</div>
<div>
<p class="text-2xl font-black text-orange-600" x-text="stats.pending"></p>
<p class="text-xs text-slate-400 uppercase">Pending</p>
</div>
</div>
</div>

<!-- Form Input Laporan -->
<div class="bg-white p-6 rounded-2xl mb-6 shadow-sm border border-slate-100">
<h3 class="font-black text-sm mb-4 text-slate-800">Input Laporan Baru</h3>

<!-- Fitur 1: Nama Pengguna & Permasalahan Utama -->
<div class="mb-4">
<label class="block text-xs font-bold text-slate-600 mb-2">Nama Pengguna</label>
<input type="text" :value="currentUser?.name" class="input-style bg-slate-100" disabled>
</div>

<div class="mb-4">
<label class="block text-xs font-bold text-slate-600 mb-2">Permasalahan Utama <span class="text-red-500">*</span></label>
<textarea x-model="newTask.masalah" class="input-style" placeholder="Masukkan masalah atau kerusakan yang ada di dalam ruangan..."></textarea>
</div>

<!-- Fitur 2: Gedung & Ruangan -->
<div class="mb-4">
<label class="block text-xs font-bold text-slate-600 mb-2">Gedung <span class="text-red-500">*</span></label>
<select x-model="newTask.gedung" class="input-style" @change="newTask.ruangan=''">
<option value="">-- Pilih Gedung --</option>
<template x-for="(rooms,gedung) in dataLokasi">
<option :value="gedung" x-text="gedung"></option>
</template>
</select>
</div>

<div class="mb-4" x-show="newTask.gedung">
<label class="block text-xs font-bold text-slate-600 mb-2">Ruangan <span class="text-red-500">*</span></label>
<select x-model="newTask.ruangan" class="input-style" :disabled="!newTask.gedung">
<option value="">-- Pilih Ruangan --</option>
<template x-for="r in (dataLokasi[newTask.gedung]||[])">
<option :value="r" x-text="r"></option>
</template>
</select>
</div>

<div class="mb-4">
<label class="block text-xs font-bold text-slate-600 mb-2">Nama Pelapor</label>
<input x-model="newTask.pelapor" type="text" class="input-style" placeholder="Nama pelapor (opsional)">
</div>

<!-- Fitur 3: Penyelesaian & Status & Foto -->
<div class="mb-4">
<label class="block text-xs font-bold text-slate-600 mb-2">Status Pekerjaan <span class="text-red-500">*</span></label>
<div class="flex gap-2">
<button @click="newTask.statusPekerjaan='Selesai'" :class="newTask.statusPekerjaan==='Selesai'?'bg-emerald-600 text-white':'bg-slate-100'" class="flex-1 py-3 rounded-xl font-bold text-sm">Selesai</button>
<button @click="newTask.statusPekerjaan='Belum Selesai'" :class="newTask.statusPekerjaan==='Belum Selesai'?'bg-orange-500 text-white':'bg-slate-100'" class="flex-1 py-3 rounded-xl font-bold text-sm">Pending</button>
</div>
</div>

<div class="mb-4" x-show="newTask.statusPekerjaan==='Selesai'">
<label class="block text-xs font-bold text-slate-600 mb-2">Penyelesaian <span class="text-red-500">*</span></label>
<textarea x-model="newTask.penyelesaian" class="input-style" placeholder="Tuliskan penyelesaian masalah yang telah dilakukan..."></textarea>
</div>

<div class="mb-4" x-show="newTask.statusPekerjaan==='Belum Selesai'">
<label class="block text-xs font-bold text-slate-600 mb-2">Alasan Pending / Tidak Bisa Diselesaikan <span class="text-red-500">*</span></label>
<textarea x-model="newTask.alasanPending" class="input-style" placeholder="Tuliskan alasan mengapa pekerjaan belum bisa diselesaikan..."></textarea>
</div>

<div class="mb-4">
<label class="block text-xs font-bold text-slate-600 mb-2">Foto Hasil Pekerjaan</label>
<label class="block w-full h-32 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer overflow-hidden">
<template x-if="!newTask.foto">
<div class="text-center">
<svg class="w-10 h-10 mx-auto text-slate-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
<p class="text-xs text-slate-500">Klik untuk upload foto</p>
</div>
</template>
<template x-if="newTask.foto">
<img :src="newTask.foto" class="w-full h-full object-cover">
</template>
<input type="file" accept="image/*" class="hidden" @change="handleFileUpload">
</label>
</div>

<!-- Fitur 4: Tombol Simpan -->
<button @click="simpanTugas" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold hover:bg-blue-700 transition">SIMPAN LAPORAN</button>
</div>

<!-- Fitur 5: Export Excel -->
<div class="mb-6">
<button @click="exportToExcel" :disabled="isExporting" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold hover:bg-emerald-700 disabled:opacity-50">
<span x-text="isExporting?'Mengekspor...':'EXPORT KE EXCEL'"></span>
</button>
</div>

<!-- Daftar Laporan -->
<div class="space-y-3">
<h3 class="font-black text-sm text-slate-700 mb-3">Riwayat Laporan</h3>
<template x-for="task in filteredTasks" :key="task.id">
<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 hover:shadow-md transition">
<div @click="viewingTask=task" class="flex items-start gap-4 cursor-pointer">
<div class="w-16 h-16 bg-slate-100 rounded-xl overflow-hidden shrink-0">
<template x-if="task.foto"><img :src="task.foto" class="w-full h-full object-cover"></template>
<template x-if="!task.foto"><div class="w-full h-full flex items-center justify-center text-slate-300 text-xs">No Image</div></template>
</div>
<div class="flex-1">
<h4 class="font-bold text-sm text-slate-800" x-text="task.ruangan"></h4>
<p class="text-xs text-slate-500 mb-1" x-text="task.gedung"></p>
<p class="text-xs text-slate-400" x-text="`${task.tanggal} ${task.waktu}`"></p>
<div class="mt-2">
<span :class="task.status_pekerjaan==='Selesai'?'bg-emerald-100 text-emerald-700':'bg-orange-100 text-orange-700'" class="px-2 py-1 rounded text-xs font-bold" x-text="task.status_pekerjaan"></span>
</div>
</div>
</div>
<div class="mt-3 flex gap-2">
<button @click="shareToWhatsApp(task)" class="flex-1 bg-green-500 text-white py-2 rounded-lg text-xs font-bold hover:bg-green-600 transition flex items-center justify-center gap-1">
<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24"><path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413Z"/></svg>
Share WhatsApp
</button>
<template x-if="task.status_pekerjaan!=='Selesai'">
<button @click="editPendingTask(task)" class="flex-1 bg-emerald-500 text-white py-2 rounded-lg text-xs font-bold hover:bg-emerald-600 transition">Edit Selesai</button>
</template>
</div>
</div>
</template>
<div x-show="filteredTasks.length===0" class="text-center py-10">
<p class="text-sm text-slate-400">Belum ada laporan</p>
</div>
</div>
</div>

<!-- Modal Detail Laporan -->
<div x-show="viewingTask" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60" @click.away="viewingTask=null">
<div class="bg-white w-full max-w-md rounded-2xl overflow-hidden shadow-2xl" @click.stop>
<div class="h-64 bg-slate-100 relative">
<template x-if="viewingTask?.foto"><img :src="viewingTask.foto" class="w-full h-full object-cover"></template>
<template x-if="!viewingTask?.foto"><div class="w-full h-full flex items-center justify-center text-slate-300 font-bold">No Image</div></template>
<div class="absolute top-4 right-4">
<span :class="viewingTask?.statusPekerjaan==='Selesai'?'bg-emerald-500':'bg-orange-500'" class="px-3 py-1 rounded-full text-xs font-black text-white" x-text="viewingTask?.statusPekerjaan"></span>
</div>
</div>
<div class="p-6">
<h3 class="text-xl font-black text-slate-800 mb-2" x-text="viewingTask?.ruangan"></h3>
<p class="text-xs text-blue-600 font-bold mb-4" x-text="viewingTask?.gedung"></p>
<div class="space-y-3 mb-6">
<div class="bg-slate-50 p-3 rounded-xl">
<p class="text-xs text-slate-500 mb-1"><strong>Teknisi:</strong> <span x-text="viewingTask?.teknisi"></span></p>
<p class="text-xs text-slate-500 mb-1"><strong>Pelapor:</strong> <span x-text="viewingTask?.pelapor||'-'"></span></p>
<p class="text-xs text-slate-500"><strong>Waktu:</strong> <span x-text="`${viewingTask?.tanggal} ${viewingTask?.waktu}`"></span></p>
</div>
<div class="bg-slate-50 p-3 rounded-xl">
<p class="text-xs font-bold text-slate-600 mb-1">Permasalahan:</p>
<p class="text-sm text-slate-800" x-text="viewingTask?.masalah"></p>
</div>
<div class="bg-blue-50 p-3 rounded-xl border border-blue-100">
<p class="text-xs font-bold text-blue-600 mb-1">Penyelesaian:</p>
<p class="text-sm text-blue-800" x-text="viewingTask?.penyelesaian"></p>
</div>
</div>
<button @click="viewingTask=null" class="w-full bg-slate-100 text-slate-700 py-3 rounded-xl font-bold hover:bg-slate-200">TUTUP</button>
</div>
</div>
</div>

<!-- PROFILE PAGE -->
<div x-show="page==='profile'" class="min-h-screen bg-slate-50 p-4">
<div class="max-w-md mx-auto">
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 mb-4">
<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-black text-slate-800">Profil Pengguna</h2>
<button @click="page='dashboard'" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200">Kembali</button>
</div>

<div class="text-center mb-6">
<div class="w-24 h-24 bg-slate-100 rounded-full overflow-hidden mx-auto mb-4">
<template x-if="viewingUser?.profile_photo"><img :src="viewingUser.profile_photo" class="w-full h-full object-cover"></template>
<template x-if="!viewingUser?.profile_photo"><div class="w-full h-full flex items-center justify-center text-slate-400 text-2xl">üë§</div></template>
</div>
<h3 class="text-lg font-black text-slate-800" x-text="viewingUser?.name"></h3>
<p class="text-sm text-slate-500" x-text="viewingUser?.role==='admin'?'Administrator':'Teknisi'"></p>
</div>

<div class="space-y-4">
<div class="bg-slate-50 p-4 rounded-xl">
<p class="text-xs font-bold text-slate-600 mb-1">Username</p>
<p class="text-sm text-slate-800" x-text="viewingUser?.username"></p>
</div>
<div class="bg-slate-50 p-4 rounded-xl">
<p class="text-xs font-bold text-slate-600 mb-1">Password</p>
<p class="text-sm text-slate-800" x-text="viewingUser?.password"></p>
</div>
<div class="bg-slate-50 p-4 rounded-xl">
<p class="text-xs font-bold text-slate-600 mb-1">Bidang/Bagian Teknisi</p>
<p class="text-sm text-slate-800" x-text="viewingUser?.specialization || 'Tidak diset'"></p>
</div>
<div class="bg-slate-50 p-4 rounded-xl">
<p class="text-xs font-bold text-slate-600 mb-1">User ID</p>
<p class="text-sm text-slate-800" x-text="viewingUser?.id"></p>
</div>
</div>

<template x-if="viewingUser?.id===currentUser?.id">
<div class="mt-6">
<button @click="newUserProfile={name:viewingUser.name,username:viewingUser.username,password:viewingUser.password,specialization:viewingUser.specialization||'',profilePhoto:viewingUser.profile_photo};page='editProfile'" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Edit Profil</button>
</div>
</template>
</div>
</div>
</div>

<!-- EDIT PROFILE PAGE -->
<div x-show="page==='editProfile'" class="min-h-screen bg-slate-50 p-4">
<div class="max-w-md mx-auto">
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-black text-slate-800">Edit Profil</h2>
<button @click="page='profile'" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200">Batal</button>
</div>

<div class="space-y-4">
<div>
<label class="block text-xs font-bold text-slate-600 mb-2">Nama Lengkap</label>
<input x-model="newUserProfile.name" type="text" class="input-style" placeholder="Nama Lengkap">
</div>
<div>
<label class="block text-xs font-bold text-slate-600 mb-2">Username</label>
<input x-model="newUserProfile.username" type="text" class="input-style" placeholder="Username">
</div>
<div>
<label class="block text-xs font-bold text-slate-600 mb-2">Password</label>
<input x-model="newUserProfile.password" type="password" class="input-style" placeholder="Password">
</div>
<div>
<label class="block text-xs font-bold text-slate-600 mb-2">Bidang/Bagian Teknisi (opsional)</label>
<input x-model="newUserProfile.specialization" type="text" class="input-style" placeholder="Contoh: IT, Teknisi AC, Teknisi Listrik, dll">
</div>
<div>
<label class="block text-xs font-bold text-slate-600 mb-2">Foto Profil</label>
<label class="block w-full h-24 bg-slate-50 rounded-xl border-2 border-dashed border-slate-300 flex items-center justify-center cursor-pointer overflow-hidden">
<template x-if="!newUserProfile.profilePhoto">
<div class="text-center">
<svg class="w-8 h-8 mx-auto text-slate-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
<p class="text-xs text-slate-500">Klik untuk upload foto</p>
</div>
</template>
<template x-if="newUserProfile.profilePhoto">
<img :src="newUserProfile.profilePhoto" class="w-full h-full object-cover">
</template>
<input type="file" accept="image/*" class="hidden" @change="handleProfilePhotoUpload">
</label>
</div>
<button @click="updateProfile" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Simpan Perubahan</button>
</div>
</div>
</div>
</div>

<!-- ADMIN PAGE -->
<div x-show="page==='admin'" class="min-h-screen bg-slate-50 p-4">
<div class="max-w-md mx-auto">
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 mb-4">
<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-black text-slate-800">Manajemen User</h2>
<button @click="page='dashboard'" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200">Kembali</button>
</div>

<div class="mb-6">
<div class="bg-purple-50 p-4 rounded-xl border border-purple-100">
<p class="text-sm font-bold text-purple-800">Total User Terdaftar: <span x-text="regularUsers.length"></span></p>
</div>
</div>

<div class="space-y-3">
<template x-for="user in regularUsers" :key="user.id">
<div class="bg-slate-50 p-4 rounded-xl">
<div class="flex items-center gap-3">
<div class="w-12 h-12 bg-slate-200 rounded-full overflow-hidden">
<template x-if="user.profile_photo"><img :src="user.profile_photo" class="w-full h-full object-cover"></template>
<template x-if="!user.profile_photo"><div class="w-full h-full flex items-center justify-center text-slate-400 text-xs">üë§</div></template>
</div>
<div class="flex-1">
<h4 class="font-bold text-sm text-slate-800" x-text="user.name"></h4>
<p class="text-xs text-slate-500" x-text="user.username"></p>
</div>
<div class="flex gap-2">
<button @click="viewUserProfile(user)" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-200">Lihat</button>
<button @click="deleteUser(user.id)" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-xs font-bold hover:bg-red-200">Hapus</button>
</div>
</div>
</div>
</template>
<div x-show="regularUsers.length===0" class="text-center py-10">
<p class="text-sm text-slate-400">Belum ada user terdaftar</p>
</div>
</div>
</div>
</div>
</div>

<!-- ADMIN DASHBOARD -->
<div x-show="page==='adminDashboard'" class="min-h-screen bg-slate-50 p-4">
<div class="max-w-6xl mx-auto">
<!-- Header -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 mb-6">
<div class="flex items-center justify-between mb-4">
<div class="flex items-center gap-3">
<div class="w-12 h-12 bg-purple-100 rounded-full overflow-hidden">
<template x-if="currentUser?.profile_photo"><img :src="currentUser.profile_photo" class="w-full h-full object-cover"></template>
<template x-if="!currentUser?.profile_photo"><div class="w-full h-full flex items-center justify-center text-purple-400 text-xs">üë§</div></template>
</div>
<div>
<h2 class="text-xl font-black text-purple-800">Super Admin Dashboard</h2>
<p class="text-sm text-slate-500">Kelola Semua User Terdaftar</p>
</div>
</div>
<div class="flex gap-2">
<button @click="logout" class="px-4 py-2 bg-red-100 text-red-600 rounded-xl text-sm font-bold hover:bg-red-200">Logout</button>
</div>
</div>

<!-- Data User -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 mb-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-black text-slate-800">Data User Terdaftar</h3>
<div class="flex gap-2">
<button @click="fetchUsers()" class="px-3 py-1 bg-green-100 text-green-600 rounded-lg text-xs font-bold hover:bg-green-200 transition">
üîÑ Refresh Users
</button>
<button @click="page='admin'" class="px-3 py-1 bg-purple-100 text-purple-600 rounded-lg text-xs font-bold hover:bg-purple-200 transition">
‚ûï Tambah User
</button>
</div>
</div>
<div class="mb-4">
<p class="text-sm text-slate-500">Total User: <span x-text="regularUsers.length" class="font-bold text-blue-600"></span></p>
</div>

<!-- Data Statistik -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 mb-6">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-black text-slate-800">Data Statistik</h3>
<button @click="forceRefreshStats()" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-200 transition">
üîÑ Refresh Stats
</button>
</div>
<div class="grid grid-cols-3 gap-4">
<div class="text-center cursor-pointer hover:scale-105 transition-transform" @click="showDailyDetail=true">
<h4 class="text-sm font-bold text-purple-600 mb-2">Harian</h4>
<div class="bg-purple-50 p-4 rounded-xl hover:bg-purple-100 transition">
<p class="text-xl font-black text-purple-800" x-text="adminStats.todayTasks"></p>
<p class="text-xs text-purple-500">Hari Ini</p>
</div>
</div>
<div class="text-center cursor-pointer hover:scale-105 transition-transform" @click="showWeeklyByWeekDetail=true">
<h4 class="text-sm font-bold text-blue-600 mb-2">Mingguan</h4>
<div class="bg-blue-50 p-4 rounded-xl hover:bg-blue-100 transition">
<p class="text-xl font-black text-blue-800" x-text="adminStats.weeklyTasks"></p>
<p class="text-xs text-blue-500">7 Hari Terakhir</p>
<p class="text-xs text-blue-400 mt-1">Selesai: <span x-text="adminStats.thisWeekCompleted"></span></p>
</div>
</div>
<div class="text-center cursor-pointer hover:scale-105 transition-transform" @click="showMonthlyDetail=true">
<h4 class="text-sm font-bold text-emerald-600 mb-2">Bulanan</h4>
<div class="bg-emerald-50 p-4 rounded-xl hover:bg-emerald-100 transition">
<p class="text-xl font-black text-emerald-800" x-text="adminStats.monthlyTasks"></p>
<p class="text-xs text-emerald-500">Bulan Ini</p>
<p class="text-xs text-emerald-400 mt-1">Selesai: <span x-text="adminStats.thisMonthCompleted"></span></p>
</div>
</div>
</div>
</div>

<!-- Export Excel -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 mb-6">
<h3 class="text-lg font-black text-slate-800 mb-4">Export Excel Data Keseluruhan</h3>
<button @click="exportAllTasksToExcel" :disabled="isExporting" class="w-full bg-emerald-600 text-white py-4 rounded-xl font-bold hover:bg-emerald-700 disabled:opacity-50 transition">
<span x-text="isExporting?'Mengekspor...':'EXPORT EXCEL DATA KESELURUHAN USER'"></span>
</button>
</div>

<!-- User Management -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
<div class="flex items-center justify-between mb-4">
<h3 class="text-lg font-black text-slate-800">Kelola User Terdaftar</h3>
<div class="flex gap-2 flex-wrap">
<button @click="refreshAllData" class="px-4 py-2 bg-green-100 text-green-600 rounded-xl text-sm font-bold hover:bg-green-200">üîÑ Refresh</button>
</div>
</div>
<div class="space-y-4">
<template x-for="user in regularUsers" :key="user.id">
<div class="bg-slate-50 p-4 rounded-xl hover:bg-slate-100 transition cursor-pointer" @click="viewUserProfileWithTasks(user)">
<div class="flex items-center gap-4 mb-3">
<div class="w-12 h-12 bg-slate-200 rounded-full overflow-hidden">
<template x-if="user.profile_photo"><img :src="user.profile_photo" class="w-full h-full object-cover"></template>
<template x-if="!user.profile_photo"><div class="w-full h-full flex items-center justify-center text-slate-400 text-xs">üë§</div></template>
</div>
<div class="flex-1">
<h4 class="font-bold text-slate-800" x-text="user.name"></h4>
<p class="text-sm text-slate-500" x-text="user.username"></p>
<p class="text-xs text-blue-500 mt-1">Klik untuk lihat profil & semua laporan</p>
</div>
<div class="flex gap-2">
<button @click.stop="editUserCredentials(user.id)" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-200">Edit Password</button>
<button @click.stop="deleteUser(user.id)" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-xs font-bold hover:bg-red-200">Hapus</button>
</div>
</div>

<div class="grid grid-cols-3 gap-3 text-center">
<div class="bg-blue-50 p-3 rounded-xl">
<p class="text-lg font-black text-blue-600" x-text="getUserStats(user.id).totalTasks"></p>
<p class="text-xs text-blue-500">Total Pekerjaan</p>
</div>
<div class="bg-emerald-50 p-3 rounded-xl">
<p class="text-lg font-black text-emerald-600" x-text="getUserStats(user.id).completedTasks"></p>
<p class="text-xs text-emerald-500">Selesai</p>
</div>
<div class="bg-orange-50 p-3 rounded-xl">
<p class="text-lg font-black text-orange-600" x-text="getUserStats(user.id).pendingTasks"></p>
<p class="text-xs text-orange-500">Pending</p>
</div>
</div>
</div>
</template>
<div x-show="regularUsers.length===0" class="text-center py-10">
<p class="text-sm text-slate-400">Belum ada user terdaftar</p>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- USER REPORTS PAGE -->
<div x-show="page==='userReports'" class="min-h-screen bg-slate-50 p-4">
<div class="max-w-4xl mx-auto">
<!-- Header -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 mb-6">
<div class="flex items-center gap-4 mb-4">
<button @click="page='adminDashboard'" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200">
‚Üê Kembali
</button>
<div class="flex items-center gap-3">
<div class="w-12 h-12 bg-slate-200 rounded-full overflow-hidden">
<template x-if="viewingUser?.profile_photo"><img :src="viewingUser.profile_photo" class="w-full h-full object-cover"></template>
<template x-if="!viewingUser?.profile_photo"><div class="w-full h-full flex items-center justify-center text-slate-400 text-xs">üë§</div></template>
</div>
<div>
<h2 class="text-xl font-black text-slate-800" x-text="viewingUser?.name"></h2>
<p class="text-sm text-slate-500" x-text="viewingUser?.username"></p>
</div>
</div>
</div>

<!-- User Stats -->
<div class="grid grid-cols-3 gap-4">
<div class="bg-blue-50 p-4 rounded-xl text-center">
<p class="text-2xl font-black text-blue-600" x-text="getUserStats(viewingUser?.id).totalTasks"></p>
<p class="text-xs text-blue-500">Total Pekerjaan</p>
</div>
<div class="bg-emerald-50 p-4 rounded-xl text-center">
<p class="text-2xl font-black text-emerald-600" x-text="getUserStats(viewingUser?.id).completedTasks"></p>
<p class="text-xs text-emerald-500">Selesai</p>
</div>
<div class="bg-orange-50 p-4 rounded-xl text-center">
<p class="text-2xl font-black text-orange-600" x-text="getUserStats(viewingUser?.id).pendingTasks"></p>
<p class="text-xs text-orange-500">Pending</p>
</div>
</div>
</div>

<!-- User Reports List -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
<h3 class="text-lg font-black text-slate-800 mb-4">Laporan User</h3>
<div class="space-y-3">
<template x-for="task in getUserReports(viewingUser?.id)" :key="task.id">
<div class="bg-slate-50 p-4 rounded-xl hover:bg-slate-100 transition">
<div class="flex items-start gap-4">
<div class="w-16 h-16 bg-slate-200 rounded-xl overflow-hidden shrink-0">
<template x-if="task.foto"><img :src="task.foto" class="w-full h-full object-cover"></template>
<template x-if="!task.foto"><div class="w-full h-full flex items-center justify-center text-slate-300 text-xs">No Image</div></template>
</div>
<div class="flex-1">
<div class="flex items-center gap-2 mb-2">
<h4 class="font-bold text-sm text-slate-800" x-text="task.ruangan"></h4>
<span :class="task.status_pekerjaan==='Selesai'?'bg-emerald-100 text-emerald-700':'bg-orange-100 text-orange-700'" class="px-2 py-1 rounded text-xs font-bold" x-text="task.status_pekerjaan"></span>
</div>
<h5 class="font-semibold text-sm text-slate-700 mb-1" x-text="task.gedung"></h5>
<p class="text-xs text-slate-500 mb-1" x-text="`${task.tanggal} ${task.waktu}`"></p>
<p class="text-xs text-slate-600 mb-2 line-clamp-2" x-text="task.masalah"></p>
<div class="flex gap-2">
<button @click="viewingTask=task" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-200">Detail</button>
<button @click="shareToWhatsApp(task)" class="px-3 py-1 bg-green-100 text-green-600 rounded-lg text-xs font-bold hover:bg-green-200">Share</button>
<template x-if="task.status_pekerjaan!=='Selesai'">
<button @click="editPendingTask(task)" class="px-3 py-1 bg-emerald-100 text-emerald-600 rounded-lg text-xs font-bold hover:bg-emerald-200">Edit Selesai</button>
</template>
<button @click="deleteTask(task.id)" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-xs font-bold hover:bg-red-200">Hapus</button>
</div>
</div>
</div>
</div>
</template>
<div x-show="getUserReports(viewingUser?.id).length===0" class="text-center py-10">
<p class="text-sm text-slate-400">User ini belum memiliki laporan</p>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- EDIT PENDING TASK PAGE -->
<div x-show="page==='editPendingTask'" class="min-h-screen bg-slate-50 p-4">
<div class="max-w-md mx-auto">
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
<div class="flex items-center justify-between mb-6">
<h2 class="text-xl font-black text-slate-800">Edit Status Pekerjaan</h2>
<button @click="page='userReports'; editingTask=null" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200">Batal</button>
</div>

<template x-if="editingTask">
<div class="space-y-4">
<div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
<p class="text-xs font-bold text-orange-600 mb-2">Status Awal</p>
<p class="text-sm text-orange-800 font-bold">Belum Selesai</p>
<p class="text-xs text-orange-600 mt-1">Alasan Pending:</p>
<p class="text-sm text-orange-700" x-text="editingTask.originalPenyelesaian"></p>
<p class="text-xs text-orange-500 mt-2" x-text="`${editingTask.tanggal} ${editingTask.waktu}`"></p>
</div>

<div class="bg-slate-50 p-4 rounded-xl">
<p class="text-xs font-bold text-slate-600 mb-1">Lokasi</p>
<p class="text-sm text-slate-800 font-bold" x-text="`${editingTask.gedung} - ${editingTask.ruangan}`"></p>
</div>

<div class="bg-slate-50 p-4 rounded-xl">
<p class="text-xs font-bold text-slate-600 mb-1">Permasalahan</p>
<p class="text-sm text-slate-800" x-text="editingTask.masalah"></p>
</div>

<div>
<label class="block text-xs font-bold text-slate-600 mb-2">Penyelesaian Pekerjaan <span class="text-red-500">*</span></label>
<textarea x-model="editingTask.newPenyelesaian" class="input-style" placeholder="Deskripsikan bagaimana pekerjaan diselesaikan..." rows="4"></textarea>
</div>

<div class="bg-emerald-50 p-4 rounded-xl border border-emerald-100">
<p class="text-xs font-bold text-emerald-600 mb-1">Status Baru</p>
<p class="text-sm text-emerald-800 font-bold">Selesai</p>
<p class="text-xs text-emerald-500 mt-1" x-text="`${dayjs().format('DD/MM/YYYY')} ${dayjs().format('HH:mm')}`"></p>
</div>

<button @click="saveEditedTask" class="w-full bg-emerald-600 text-white py-3 rounded-xl font-bold hover:bg-emerald-700 transition">Simpan Perubahan</button>
</div>
</template>
</div>
</div>
</div>

<!-- USER PROFILE WITH TASKS PAGE -->
<div x-show="page==='userProfileWithTasks'" class="min-h-screen bg-slate-50 p-4">
<div class="max-w-4xl mx-auto">
<!-- Header -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100 mb-6">
<div class="flex items-center gap-4 mb-4">
<button @click="page='adminDashboard'" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200">
‚Üê Kembali
</button>
<div class="flex items-center gap-3">
<div class="w-12 h-12 bg-slate-200 rounded-full overflow-hidden">
<template x-if="viewingUser?.profile_photo"><img :src="viewingUser.profile_photo" class="w-full h-full object-cover"></template>
<template x-if="!viewingUser?.profile_photo"><div class="w-full h-full flex items-center justify-center text-slate-400 text-xs">üë§</div></template>
</div>
<div>
<h2 class="text-xl font-black text-slate-800" x-text="viewingUser?.name"></h2>
<p class="text-sm text-slate-500" x-text="viewingUser?.username"></p>
</div>
</div>
</div>

<!-- User Stats -->
<div class="grid grid-cols-3 gap-4 mb-6">
<div class="bg-blue-50 p-4 rounded-xl text-center">
<p class="text-2xl font-black text-blue-600" x-text="getUserStats(viewingUser?.id).totalTasks"></p>
<p class="text-xs text-blue-500">Total Pekerjaan</p>
</div>
<div class="bg-emerald-50 p-4 rounded-xl text-center">
<p class="text-2xl font-black text-emerald-600" x-text="getUserStats(viewingUser?.id).completedTasks"></p>
<p class="text-xs text-emerald-500">Selesai</p>
</div>
<div class="bg-orange-50 p-4 rounded-xl text-center">
<p class="text-2xl font-black text-orange-600" x-text="getUserStats(viewingUser?.id).pendingTasks"></p>
<p class="text-xs text-orange-500">Pending</p>
</div>
</div>

<!-- Edit Profile Section -->
<div class="bg-slate-50 p-4 rounded-xl">
<h3 class="text-sm font-black text-slate-800 mb-4">Edit Profil User</h3>
<div class="space-y-3">
<div>
<label class="block text-xs font-bold text-slate-600 mb-1">Nama Lengkap</label>
<input x-model="editingUserProfile.newName" type="text" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
</div>
<div>
<label class="block text-xs font-bold text-slate-600 mb-1">Username</label>
<input x-model="editingUserProfile.newUsername" type="text" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
</div>
<div>
<label class="block text-xs font-bold text-slate-600 mb-1">Password</label>
<input x-model="editingUserProfile.newPassword" type="text" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
</div>
<div>
<label class="block text-xs font-bold text-slate-600 mb-1">Bidang/Bagian Teknisi</label>
<input x-model="editingUserProfile.newSpecialization" type="text" placeholder="Contoh: Teknisi AC, Teknisi Listrik, dll" class="w-full px-3 py-2 border border-slate-200 rounded-lg text-sm">
</div>
<button @click="saveEditedUserProfile" class="w-full bg-blue-600 text-white py-2 rounded-lg text-sm font-bold hover:bg-blue-700 transition">Simpan Profil</button>
</div>
</div>
</div>

<!-- All Tasks List -->
<div class="bg-white p-6 rounded-2xl shadow-xl border border-slate-100">
<h3 class="text-lg font-black text-slate-800 mb-4">Semua Laporan User</h3>
<div class="space-y-3">
<template x-for="task in getUserAllTasks(viewingUser?.id)" :key="task.id">
<div class="bg-slate-50 p-4 rounded-xl hover:bg-slate-100 transition">
<div class="flex items-start gap-4">
<div class="w-16 h-16 bg-slate-200 rounded-xl overflow-hidden shrink-0">
<template x-if="task.foto"><img :src="task.foto" class="w-full h-full object-cover"></template>
<template x-if="!task.foto"><div class="w-full h-full flex items-center justify-center text-slate-300 text-xs">No Image</div></template>
</div>
<div class="flex-1">
<div class="flex items-center gap-2 mb-2">
<h4 class="font-bold text-sm text-slate-800" x-text="task.ruangan"></h4>
<span :class="task.status_pekerjaan==='Selesai'?'bg-emerald-100 text-emerald-700':'bg-orange-100 text-orange-700'" class="px-2 py-1 rounded text-xs font-bold" x-text="task.status_pekerjaan"></span>
</div>
<h5 class="font-semibold text-sm text-slate-700 mb-1" x-text="task.gedung"></h5>
<p class="text-xs text-slate-500 mb-1" x-text="`${task.tanggal} ${task.waktu}`"></p>
<p class="text-xs text-slate-600 mb-2 line-clamp-2" x-text="task.masalah"></p>
<div class="flex gap-2">
<button @click="viewingTask=task" class="px-3 py-1 bg-blue-100 text-blue-600 rounded-lg text-xs font-bold hover:bg-blue-200">Detail</button>
<button @click="shareToWhatsApp(task)" class="px-3 py-1 bg-green-100 text-green-600 rounded-lg text-xs font-bold hover:bg-green-200">Share</button>
<template x-if="task.status_pekerjaan!=='Selesai'">
<button @click="editPendingTask(task)" class="px-3 py-1 bg-emerald-100 text-emerald-600 rounded-lg text-xs font-bold hover:bg-emerald-200">Edit Selesai</button>
</template>
<button @click="deleteTask(task.id)" class="px-3 py-1 bg-red-100 text-red-600 rounded-lg text-xs font-bold hover:bg-red-200">Hapus</button>
</div>
</div>
</div>
</div>
</template>
<div x-show="getUserAllTasks(viewingUser?.id).length===0" class="text-center py-10">
<p class="text-sm text-slate-400">User ini belum memiliki laporan</p>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- DAILY DETAIL MODAL -->
<div x-show="showDailyDetail" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
<div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
<div class="p-6 border-b border-slate-200">
<div class="flex items-center justify-between">
<h3 class="text-xl font-black text-slate-800">üìä Detail Statistik Harian</h3>
<button @click="showDailyDetail=false" class="text-slate-400 hover:text-slate-600">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
</button>
</div>
<p class="text-sm text-slate-500 mt-1">Total tugas per user hari ini (<span x-text="new Date().toLocaleDateString('id-ID')"></span>)</p>
</div>
<div class="p-6 overflow-y-auto max-h-[60vh]">
<template x-for="userId in Object.keys(getDailyStatsPerUser())" :key="userId">
<div class="bg-purple-50 p-4 rounded-xl mb-3">
<div class="flex items-center justify-between">
<div>
<h4 class="font-bold text-purple-800" x-text="getDailyStatsPerUser()[userId].userName"></h4>
<p class="text-sm text-purple-600">Total: <span x-text="getDailyStatsPerUser()[userId].totalTasks"></span> tugas</p>
</div>
<div class="text-right">
<p class="text-sm text-emerald-600 font-bold">‚úÖ <span x-text="getDailyStatsPerUser()[userId].completedTasks"></span></p>
<p class="text-sm text-orange-600 font-bold">‚è≥ <span x-text="getDailyStatsPerUser()[userId].pendingTasks"></span></p>
</div>
</div>
</div>
</template>
<div x-show="Object.keys(getDailyStatsPerUser()).length===0" class="text-center py-10">
<p class="text-sm text-slate-400">Tidak ada tugas hari ini</p>
</div>
</div>
</div>
</div>

<!-- WEEKLY BY WEEK DETAIL MODAL -->
<div x-show="showWeeklyByWeekDetail" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
<div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
<div class="p-6 border-b border-slate-200">
<div class="flex items-center justify-between">
<h3 class="text-xl font-black text-slate-800">üìä Detail Statistik Mingguan</h3>
<button @click="showWeeklyByWeekDetail=false" class="text-slate-400 hover:text-slate-600">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
</button>
</div>
<p class="text-sm text-slate-500 mt-1">Total tugas per user per minggu (bulan <span x-text="new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })"></span>)</p>
</div>
<div class="p-6 overflow-y-auto max-h-[60vh]">
<template x-for="weekNum in Object.keys(getWeeklyStatsByWeek())" :key="weekNum">
<div class="mb-6">
<h4 class="font-bold text-blue-800 mb-3">üìÖ Minggu <span x-text="weekNum"></span></h4>
<div class="bg-blue-50 p-4 rounded-xl">
<div class="grid grid-cols-2 gap-4 mb-3">
<div class="text-center">
<p class="text-sm text-blue-600">Total Tugas</p>
<p class="text-xl font-black text-blue-800" x-text="getWeeklyStatsByWeek()[weekNum].totalTasks"></p>
</div>
<div class="text-center">
<p class="text-sm text-emerald-600">Selesai</p>
<p class="text-xl font-black text-emerald-800" x-text="getWeeklyStatsByWeek()[weekNum].totalCompleted"></p>
</div>
</div>
<div class="space-y-2">
<template x-for="userId in Object.keys(getWeeklyStatsByWeek()[weekNum].userStats)" :key="userId">
<div class="bg-white p-3 rounded-lg">
<div class="flex items-center justify-between">
<h5 class="font-bold text-blue-700" x-text="getWeeklyStatsByWeek()[weekNum].userStats[userId].userName"></h5>
<div class="flex gap-3">
<span class="text-sm">üìù <span x-text="getWeeklyStatsByWeek()[weekNum].userStats[userId].totalTasks"></span></span>
<span class="text-sm text-emerald-600">‚úÖ <span x-text="getWeeklyStatsByWeek()[weekNum].userStats[userId].completedTasks"></span></span>
<span class="text-sm text-orange-600">‚è≥ <span x-text="getWeeklyStatsByWeek()[weekNum].userStats[userId].pendingTasks"></span></span>
</div>
</div>
</div>
</template>
</div>
</div>
</div>
</template>
<div x-show="Object.keys(getWeeklyStatsByWeek()).length===0" class="text-center py-10">
<p class="text-sm text-slate-400">Tidak ada tugas mingguan</p>
</div>
</div>
</div>
</div>

<!-- MONTHLY DETAIL MODAL -->
<div x-show="showMonthlyDetail" x-cloak class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
<div class="bg-white rounded-2xl shadow-2xl max-w-4xl w-full max-h-[80vh] overflow-hidden">
<div class="p-6 border-b border-slate-200">
<div class="flex items-center justify-between">
<h3 class="text-xl font-black text-slate-800">üìä Detail Statistik Bulanan</h3>
<button @click="showMonthlyDetail=false" class="text-slate-400 hover:text-slate-600">
<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
</button>
</div>
<p class="text-sm text-slate-500 mt-1">Total tugas per user bulan ini (<span x-text="new Date().toLocaleDateString('id-ID', { month: 'long', year: 'numeric' })"></span>)</p>
</div>
<div class="p-6 overflow-y-auto max-h-[60vh]">
<template x-for="userId in Object.keys(getMonthlyStatsPerUser())" :key="userId">
<div class="bg-emerald-50 p-4 rounded-xl mb-3">
<div class="flex items-center justify-between">
<div>
<h4 class="font-bold text-emerald-800" x-text="getMonthlyStatsPerUser()[userId].userName"></h4>
<p class="text-sm text-emerald-600">Total: <span x-text="getMonthlyStatsPerUser()[userId].totalTasks"></span> tugas</p>
</div>
<div class="text-right">
<p class="text-sm text-emerald-600 font-bold">‚úÖ <span x-text="getMonthlyStatsPerUser()[userId].completedTasks"></span></p>
<p class="text-sm text-orange-600 font-bold">‚è≥ <span x-text="getMonthlyStatsPerUser()[userId].pendingTasks"></span></p>
</div>
</div>
</div>
</template>
<div x-show="Object.keys(getMonthlyStatsPerUser()).length===0" class="text-center py-10">
<p class="text-sm text-slate-400">Tidak ada tugas bulan ini</p>
</div>
</div>
</div>
</div>
</body>
</html>

